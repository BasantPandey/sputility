/*! SPUtility.js - v0.1.0 - 2013-08-25
* https://github.com/kitmenke/sputility
* Copyright (c) 2013 Kit Menke; Licensed MIT */
Object.create||(Object.create=function(t){function e(){}if(arguments.length>1)throw Error("Object.create implementation only accepts the first parameter.");return e.prototype=t,new e}),function(t,e){"use strict";function n(t){return t===void 0}function i(t){return"string"==typeof t}function o(t){return"number"==typeof t}function l(t){return parseInt(t,10)}function r(t){if("string"==typeof t){var e=t.match(/[0-9,.]+/g);null!==e&&(t=e[0].replace(/,/g,""),t=parseFloat(t))}return t}function s(t,e,n,i){e=isNaN(e=Math.abs(e))?2:e,n=void 0===n?".":n,i=void 0===i?",":i;var o=0>t?"-":"",l=parseInt(t=Math.abs(+t||0).toFixed(e),10)+"",r=(r=l.length)>3?r%3:0;return o+(r?l.substr(0,r)+i:"")+l.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+i)+(e?n+Math.abs(t-l).toFixed(e).slice(2):"")}function a(t){if(null===t.Controls)return null;var n=e(t.Controls).find("input");if(null!==n&&1===n.length)return n[0];throw"Unable to retrieve the input control for "+t.Name}function h(t,n){var i,o=[],l=e(t.Controls).find(n),r=e(t.Controls).find("label");if(r.length<l.length)throw"Unable to get hashtable of controls.";for(i=0;l.length>i;i++)o.push({key:e(r[i]).text(),value:l[i]});return o}function u(t){var e,n,i;try{for(i=0;t.childNodes.length>i;i+=1)if(8===t.childNodes[i].nodeType){if(n=t.childNodes[i].data,e=n.match(/SPField\w+/),null!==e)return e[0];break}}catch(o){throw"getSPFieldType error: "+(""+o)}return null}function p(t){var n,i=null;switch(t.type){case"SPFieldText":i=new m(t);break;case"SPFieldNumber":i=new F(t);break;case"SPFieldCurrency":i=new C(t);break;case"SPFieldChoice":i=new D(t);break;case"SPFieldMultiChoice":i=new k(t);break;case"SPFieldDateTime":i=new T(t);break;case"SPFieldBoolean":i=new S(t);break;case"SPFieldUser":case"SPFieldUserMulti":i=new R(t);break;case"SPFieldURL":i=new O(t);break;case"SPFieldLookup":n=e(t.controlsCell).find("select"),n.length>0?i=new V(t,n):(n=e(t.controlsCell).find("input"),i=new P(t,n));break;default:i=new w(t)}return i}function c(t){var n=null;try{if(null===t.controlsCell&&(t.controlsCell=e(t.labelCell).next()[0]),t.type=u(t.controlsCell),null===t.type)return null;n=p(t)}catch(i){throw"Error creating field named "+t.name+": "+(""+i)}return n}function d(t,i,o){var l,r,s=null,a="Unknown field";try{if(o)l=t;else if(l=e(t).children()[0],null===l||"NOBR"===l.nodeName)return null;a=e.trim(e(l).text()),r=a.lastIndexOf(" *")===a.length-2,!0===r&&(a=a.substring(0,a.length-2)),s={name:a,label:e(l),labelRow:e(t.parentNode),labelCell:t,isRequired:r,controlsRow:n(i)?null:e(i.parentNode),controlsCell:n(i)?null:i,type:null,spField:null}}catch(h){throw"getFieldParams error getting parameters for "+a+": "+(""+h)}return s}function f(){if(null===L){var t,n,i=e("table.ms-formtable td.ms-formlabel"),o=e("table.ms-formtable td.ms-formbodysurvey"),l=i.length;for(G=o.length>0,L={},t=0;l>t;t+=1)n=d(i[t],o[t],G),null!==n&&(L[n.name]=n)}}function b(t,e,n){n?(t.show(),null!==e&&e.show()):(t.hide(),null!==e&&e.hide())}function y(t){t.ReadOnlyLabel&&t.ReadOnlyLabel.html(t.GetValue())}function x(t,n){try{e(t.Controls).hide(),null===t.ReadOnlyLabel&&(t.ReadOnlyLabel=e("<div/>").text(n).addClass("sputility-readonly"),e(t.Controls).after(t.ReadOnlyLabel)),t.ReadOnlyLabel.html(n),t.ReadOnlyLabel.show()}catch(i){throw"Error making "+t.Name+" read only. "+(""+i)}return t}function v(t){var n="";return t.each(function(){n+=e(this).text()+"; "}),n.length>2&&(n=n.substring(0,n.length-2)),n}function w(t){this.Label=t.label,this.LabelRow=t.labelRow,this.Name=t.name,this.IsRequired=t.isRequired,this.Type=t.type,this.Controls=e(t.controlsCell).children()[0],this.ControlsRow=t.controlsRow,this.ReadOnlyLabel=null}function m(t){w.call(this,t),this.Textbox=a(this)}function F(t){m.call(this,t)}function C(t){F.call(this,t),this.FormatOptions={eventHandler:null,autoCorrect:!1,decimalPlaces:2}}function g(t){w.call(this,t),null!==this.Controls&&(this.FillInTextbox=e(this.Controls).find('input[type="text"]'),1===this.FillInTextbox.length?(this.FillInTextbox=this.FillInTextbox[0],this.FillInAllowed=!0,this.FillInElement=e(this.Controls).find('input[value="FillInButton"]')[0]):(this.FillInAllowed=!1,this.FillInTextbox=null,this.FillInElement=null))}function D(t){g.call(this,t),null!==this.Controls&&(this.Dropdown=e(this.Controls).find("select"),this.Dropdown=1===this.Dropdown.length?this.Dropdown[0]:[])}function k(t){g.call(this,t),null!==this.Controls&&(this.Checkboxes=h(this,'input[type="checkbox"]'),this.FillInAllowed&&(this.FillInElement=this.Checkboxes.pop().value))}function I(t,e,i,o,l){if(this.Year=t,this.Month=e,this.Day=i,this.Hour=o,this.Minute=l,this.IsTimeIncluded=!n(this.Hour)&&!n(this.Minute),this.IsTimeIncluded){if(!this.IsValidHour(this.Hour))throw'Hour parameter is not in the correct format. Needs to be formatted like "1 PM" or "12 AM".';if(!this.IsValidMinute(this.Minute))throw'Minute parameter is not in the correct format. Needs to be formatted like "00", "05" or "35".'}}function T(t){if(w.call(this,t),this.DateTextbox=e(a(this)),this.HourDropdown=null,this.MinuteDropdown=null,this.IsDateOnly=!0,null!==this.Controls){var n=e(this.Controls).find("select");null!==n&&2===n.length&&(this.HourDropdown=e(n[0]),this.MinuteDropdown=e(n[1]),this.IsDateOnly=!1)}}function S(t){w.call(this,t),this.Checkbox=e(a(this))}function O(t){if(w.call(this,t),null!==this.Controls){this.TextboxURL=null,this.TextboxDescription=null;var n=e(this.Controls).find("input");null!==n&&2===n.length&&(this.TextboxURL=e(n[0]),this.TextboxDescription=e(n[1]))}}function V(t,e){if(w.call(this,t),null!==this.Controls){if(1!==e.length)throw"Unable to get dropdown element for "+this.Name;this.Dropdown=e[0]}}function P(t,n){if(w.call(this,t),null!==this.Controls){if(1!==n.length)throw"Unable to get input elements for "+this.Name;this.Textbox=e(n[0]),this.HiddenTextbox=e('input[id="'+this.Textbox.attr("optHid")+'"]')}}function R(i){if(w.call(this,i),null!==this.Controls){this.spanUserField=null,this.upLevelDiv=null,this.textareaDownLevelTextBox=null,this.linkCheckNames=null,this.txtHiddenSpanData=null;var o=e(this.Controls).find("span.ms-usereditor");if(null!==o&&1===o.length)this.spanUserField=o[0],this.upLevelDiv=e(this.spanUserField.id+"_upLevelDiv"),this.textareaDownLevelTextBox=e(this.spanUserField.id+"_downlevelTextBox"),this.linkCheckNames=e(this.spanUserField.id+"_checkNames"),this.txtHiddenSpanData=e(this.spanUserField.id+"_hiddenSpanData"),this.GetValue=function(){return this.upLevelDiv.text()},this.SetValue=function(t){return e.browser.msie?(this.upLevelDiv.innerHTML=t,this.txtHiddenSpanData.val(t),this.linkCheckNames.click()):(this.textareaDownLevelTextBox.val(t),this.linkCheckNames.onclick()),y(this),this};else if(!n(t.SPClientPeoplePicker)){var l=e(this.Controls).children()[0];this.ClientPeoplePicker=t.SPClientPeoplePicker.SPClientPeoplePickerDict[e(l).attr("id")],this.EditorInput=e(this.Controls).find("[id$='_EditorInput']")[0],this.HiddenInput=e(this.Controls).find("[id$='_HiddenInput']")[0],this.AutoFillDiv=e(this.Controls).find("[id$='_AutoFillDiv']")[0],this.ResolvedList=e(this.Controls).find("[id$='_ResolvedList']")[0],this.GetValue=function(){var t=e(this.ResolvedList).find("span.ms-entity-resolved");return t.length>0?v(t):""},this.SetValue=function(t){return this.ClientPeoplePicker.AddUserKeys(t,!1),y(this),this}}}}function H(t){return"boolean"==typeof t&&(N=t),N}function M(t){f();var e=L[t];if(n(e))throw"Unable to get a SPField named "+t;return null===e.spField&&(e.spField=c(e)),e.spField}var L=null,N=!1,G=!1;w.prototype.Show=function(){return b(this.LabelRow,this.ControlsRow,!0),this},w.prototype.Hide=function(){return b(this.LabelRow,this.ControlsRow,!1),this},w.prototype.MakeReadOnly=function(){return x(this,""+this.GetValue())},w.prototype.MakeEditable=function(){try{e(this.Controls).hide(),null!==this.ReadOnlyLabel&&e(this.ReadOnlyLabel).hide()}catch(t){alert("Error making "+this.Name+" editable. "+(""+t))}return this},w.prototype.toString=function(){return this.Name},w.prototype.GetValue=function(){throw"GetValue not yet implemented for "+this.Type+" in "+this.Name},w.prototype.SetValue=function(){throw"SetValue not yet implemented for "+this.Type+" in "+this.Name},m.prototype=Object.create(w.prototype),m.prototype.GetValue=function(){return e(this.Textbox).val()},m.prototype.SetValue=function(t){return e(this.Textbox).val(t),y(this),this},F.prototype=Object.create(m.prototype),F.prototype.GetValue=function(){return r(e(this.Textbox).val())},C.prototype=Object.create(F.prototype),C.prototype.Format=function(){this.FormatOptions.autoCorrect?(this.FormatOptions.eventHandler=e.proxy(function(){this.SetValue(this.GetFormattedValue())},this),e(this.Textbox).on("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler()):this.FormatOptions.eventHandler&&(e(this.Textbox).off("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler=null)},C.prototype.GetFormattedValue=function(){var t=this.GetValue();return"number"==typeof t&&(t="$"+s(t,this.FormatOptions.decimalPlaces)),t},C.prototype.MakeReadOnly=function(){return x(this,this.GetFormattedValue())},g.prototype=Object.create(w.prototype),g.prototype._getFillInValue=function(){return this.FillInTextbox.val()},g.prototype._setFillInValue=function(t){this.FillInTextbox.val(t)},D.prototype=Object.create(g.prototype),D.prototype.GetValue=function(){return this.FillInAllowed&&this.FillInElement.checked===!0?e(this.FillInTextbox).val():e(this.Dropdown).val()},D.prototype.SetValue=function(t){var n=e(this.Dropdown).find('option[value="'+t+'"]').length>0;if(!n&&this.FillInAllowed)n?(e(this.Dropdown).val(t),this.FillInElement.checked=!1):(this.FillInElement.checked=!0,e(this.FillInTextbox).val(t));else{if(!n)throw"Unable to set value for "+this.Name+' the value "'+t+'" was not found.';e(this.Dropdown).val(t)}return y(this),this},k.prototype=Object.create(g.prototype),k.prototype.GetValue=function(){var t=[];return e(this.Checkboxes).each(function(e,n){var i=n.value;i.checked===!0&&t.push(n.key)}),this.FillInAllowed&&this.FillInElement.checked===!0&&t.push(e(this.FillInTextbox).val()),t},k.prototype.SetValue=function(t,i){var o=null;return i=n(i)?!0:i,e(this.Checkboxes).each(function(e,n){return n.key===t?(o=n.value,!1):void 0}),null===o&&this.FillInAllowed&&(o=this.FillInElement,e(this.FillInTextbox).val(t)),null!==o&&(o.checked=i),y(this),this},I.prototype.IsValidDate=function(){return!n(this.Year)&&!n(this.Month)&&!n(this.Day)},I.prototype.IsValidHour=function(t){return!n(t)&&/^([1-9]|10|11|12) (AM|PM)$/.test(t)},I.prototype.IsValidMinute=function(t){return!n(t)&&/^([0-5](0|5))$/.test(t)},I.prototype.PadWithZero=function(t){return n(t)||null===t?"":i(t)&&(t=l(t),isNaN(t))?"":"number"==typeof t&&10>t?"0"+(""+t):""+t},I.prototype.GetShortDateString=function(){if(!this.IsValidDate())return"";var t=this.PadWithZero(this.Month)+"/"+this.PadWithZero(this.Day)+"/"+this.PadWithZero(this.Year);return t},I.prototype.toString=function(){var t,e=this.GetShortDateString();return this.IsValidHour(this.Hour)&&this.IsValidMinute(this.Minute)&&(t=this.Hour.split(" "),e+=" "+t[0]+":"+this.Minute+t[1]),e},T.prototype=Object.create(w.prototype),T.prototype.GetValue=function(){var t,e,n,i=this.DateTextbox.val();return null!==this.HourDropdown&&null!==this.MinuteDropdown&&(t=this.HourDropdown.val(),e=this.MinuteDropdown.val()),n=i.split("/"),3===n.length?new I(n[2],n[0],n[1],t,e):""},T.prototype.SetValue=function(t,e,n,i,o){var l=new I(t,e,n,i,o);return this.DateTextbox.val(l.GetShortDateString()),null!==this.HourDropdown&&null!==this.MinuteDropdown&&(this.HourDropdown.val(l.Hour),this.MinuteDropdown.val(l.Minute)),y(this),this},S.prototype=Object.create(w.prototype),S.prototype.GetValue=function(){return!!this.Checkbox.val()},S.prototype.SetValue=function(t){return this.Checkbox.val(t),y(this),this},O.prototype=Object.create(w.prototype),O.prototype.GetValue=function(){return[this.TextboxURL.val(),this.TextboxDescription.val()]},O.prototype.SetValue=function(t,e){return this.TextboxURL.val(t),this.TextboxDescription.val(e),y(this),this},O.prototype.MakeReadOnly=function(t){var e,n=this.GetValue();return e=t&&!0===t.TextOnly?n[0]+", "+n[1]:'<a href="'+n[0]+'">'+n[1]+"</a>",x(this,e)},V.prototype=Object.create(w.prototype),V.prototype.GetValue=function(){return this.Dropdown.options[this.Dropdown.selectedIndex].text},V.prototype.SetValue=function(t){if(o(t))e(this.Dropdown).val(t);else{var n,i,l;for(i=this.Dropdown.options,n=0;i.length>n;n+=1)if(l=i[n],l.text===t){this.Dropdown.selectedIndex=n;break}}return y(this),this},P.prototype=Object.create(w.prototype),P.prototype.GetValue=function(){return this.Textbox.val()},P.prototype.SetValue=function(t){var e,n,i,o,r,s=[];for(e=this.Textbox.attr("choices"),e=e.split(/\|(?=\d+)/),s.push(e[0]),o=1;e.length-1>o;o++)r=e[o].indexOf("|"),s.push(e[o].substring(0,r)),s.push(e[o].substring(r+1));for(s.push(e[e.length-1]),o=0;s.length>o;o+=2)if(n=l(s[o+1]),i=s[o],t===n||t===i){this.Textbox.val(i);break}return null!==n&&this.HiddenTextbox.val(n),y(this),this},R.prototype=Object.create(w.prototype);var U=function(t){this._defaults={debug:!1},this.settings=e.extend({},t,this._defaults)};U.GetSPField=M,U.Debug=H,t.SPUtility=U}(window,jQuery);