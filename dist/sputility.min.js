/*! SPUtility.js - v0.1.0 - 2013-08-15
* https://github.com/kitmenke/jquery.sputility
* Copyright (c) 2013 Kit Menke; Licensed MIT */
Object.create||(Object.create=function(t){function e(){}if(arguments.length>1)throw Error("Object.create implementation only accepts the first parameter.");return e.prototype=t,new e}),function(t,e){"use strict";function n(t){return t===void 0}function o(t){return"string"==typeof t}function l(t,e){var o;if(V){if(e){t+="\r\n";for(o in e)e.hasOwnProperty(o)&&(t+=o+": "+e[o]+"\r\n")}n(console)?(S+=1,3===S&&(t="More than 3 errors (additional errors will not be shown):\r\n"+t),3>=S&&alert(t)):console.error(t)}}function i(t){if("string"==typeof t){var e=t.match(/[0-9,.]+/g);null!==e&&(t=e[0].replace(/,/g,""),t=parseFloat(t))}return t}function r(t,e,n,o){e=isNaN(e=Math.abs(e))?2:e,n=void 0===n?".":n,o=void 0===o?",":o;var l=0>t?"-":"",i=parseInt(t=Math.abs(+t||0).toFixed(e),10)+"",r=(r=i.length)>3?r%3:0;return l+(r?i.substr(0,r)+o:"")+i.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+o)+(e?n+Math.abs(t-i).toFixed(e).slice(2):"")}function s(t){if(null===t.Controls)return null;var n=e(t.Controls).find("input");if(null!==n&&1===n.length)return n[0];throw"Unable to retrieve the input control for "+t.Name}function a(t,n){var o,l=[],i=e(t.Controls).find(n),r=e(t.Controls).find("label");if(r.length<i.length)throw"Unable to get hashtable of controls.";for(o=0;i.length>o;o++)l.push({key:e(r[o]).text(),value:i[o]});return l}function h(t){var e,n,o;try{for(o=0;t.childNodes.length>o;o+=1)if(8===t.childNodes[o].nodeType){if(n=t.childNodes[o].data,e=n.match(/SPField\w+/),null!==e)return e[0];break}}catch(i){l("getSPFieldType: Error getting field type",i)}return null}function u(t){var e=null;switch(t.type){case"SPFieldText":e=new w(t);break;case"SPFieldNumber":e=new v(t);break;case"SPFieldCurrency":e=new F(t);break;case"SPFieldChoice":e=new g(t);break;case"SPFieldMultiChoice":e=new I(t);break;case"SPFieldDateTime":e=new D(t);break;default:e=new m(t)}return e}function c(t){var n=null;try{if(null===t.controlsCell&&(t.controlsCell=e(t.labelCell).next()[0]),t.type=h(t.controlsCell),null===t.type)return null;n=u(t)}catch(o){l("createSPField: Error creating field for "+t.name,o)}return n}function p(t,o,i){var r,s,a=null,h="Unknown field";try{if(i)r=t;else if(r=e(t).children()[0],null===r||"NOBR"===r.nodeName)return null;h=e(r).text().trim(),s=h.lastIndexOf(" *")===h.length-2,!0===s&&(h=h.substring(0,h.length-2)),a={name:h,label:e(r),labelRow:e(t.parentNode),labelCell:t,isRequired:s,controlsRow:n(o)?null:e(o.parentNode),controlsCell:n(o)?null:o,type:null,spField:null}}catch(u){l("getFieldParams: Error getting field parameters "+h,u)}return a}function d(){if(null===T){var t,n,o=e("table.ms-formtable td.ms-formlabel"),l=e("table.ms-formtable td.ms-formbodysurvey"),i=o.length;for(k=l.length>0,T={},t=0;i>t;t+=1)n=p(o[t],l[t],k),null!==n&&(T[n.name]=n)}}function f(t,e,n){n?(t.show(),null!==e&&e.show()):(t.hide(),null!==e&&e.hide())}function y(t){t.ReadOnlyLabel&&t.ReadOnlyLabel.html(t.GetValue())}function b(t,n){try{e(t.Controls).hide(),null===t.ReadOnlyLabel&&(t.ReadOnlyLabel=e("<div/>").text(n).addClass("sputility-readonly"),e(t.Controls).after(t.ReadOnlyLabel)),t.ReadOnlyLabel.html(n),t.ReadOnlyLabel.show()}catch(o){l("Error making "+t.Name+" read only. "+(""+o))}return t}function m(t){this.Label=t.label,this.LabelRow=t.labelRow,this.Name=t.name,this.IsRequired=t.isRequired,this.Type=t.type,this.Controls=e(t.controlsCell).children()[0],this.ControlsRow=t.controlsRow,this.ReadOnlyLabel=null}function w(t){m.call(this,t),this.Textbox=s(this)}function v(t){w.call(this,t)}function F(t){v.call(this,t),this.FormatOptions={eventHandler:null,autoCorrect:!1,decimalPlaces:2}}function x(t){m.call(this,t),null!==this.Controls&&(this.FillInTextbox=e(this.Controls).find('input[type="text"]'),1===this.FillInTextbox.length?(this.FillInTextbox=this.FillInTextbox[0],this.FillInAllowed=!0,this.FillInElement=e(this.Controls).find('input[value="FillInButton"]')[0]):(this.FillInAllowed=!1,this.FillInTextbox=null,this.FillInElement=null))}function g(t){x.call(this,t),null!==this.Controls&&(this.Dropdown=e(this.Controls).find("select"),this.Dropdown=1===this.Dropdown.length?this.Dropdown[0]:[])}function I(t){x.call(this,t),null!==this.Controls&&(this.Checkboxes=a(this,'input[type="checkbox"]'),this.FillInAllowed&&(this.FillInElement=this.Checkboxes.pop().value))}function C(t,e,o,l,i){if(this.Year=t,this.Month=e,this.Day=o,this.Hour=l,this.Minute=i,this.IsTimeIncluded=!n(this.Hour)&&!n(this.Minute),this.IsTimeIncluded){if(!this.IsValidHour(this.Hour))throw'Hour parameter is not in the correct format. Needs to be formatted like "1 PM" or "12 AM".';if(!this.IsValidMinute(this.Minute))throw'Minute parameter is not in the correct format. Needs to be formatted like "00", "05" or "35".'}}function D(t){if(m.call(this,t),this.DateTextbox=e(s(this)),this.HourDropdown=null,this.MinuteDropdown=null,null!==this.Controls){var n=e(this.Controls).find("select");null!==n&&2===n.length&&(this.HourDropdown=e(n[0]),this.MinuteDropdown=e(n[1]))}}function O(t){return"boolean"==typeof t&&(V=t),V}function M(t){d();var e=T[t];if(n(e))throw"Unable to get a SPField named "+t;return null===e.spField&&(e.spField=c(e)),e.spField}var T=null,V=!1,k=!1,S=0;m.prototype.Show=function(){return f(this.LabelRow,this.ControlsRow,!0),this},m.prototype.Hide=function(){return f(this.LabelRow,this.ControlsRow,!1),this},m.prototype.MakeReadOnly=function(){return b(this,""+this.GetValue())},m.prototype.MakeEditable=function(){try{e(this.Controls).hide(),null!==this.ReadOnlyLabel&&e(this.ReadOnlyLabel).hide()}catch(t){alert("Error making "+this.Name+" editable. "+(""+t))}return this},m.prototype.toString=function(){return this.Name},m.prototype.GetValue=function(){throw"GetValue not yet implemented for "+this.Type+" in "+this.Name},m.prototype.SetValue=function(){throw"SetValue not yet implemented for "+this.Type+" in "+this.Name},w.prototype=Object.create(m.prototype),w.prototype.GetValue=function(){return e(this.Textbox).val()},w.prototype.SetValue=function(t){return e(this.Textbox).val(t),y(this),this},v.prototype=Object.create(w.prototype),v.prototype.GetValue=function(){return i(e(this.Textbox).val())},F.prototype=Object.create(v.prototype),F.prototype.Format=function(){this.FormatOptions.autoCorrect?(this.FormatOptions.eventHandler=e.proxy(function(){this.SetValue(this.GetFormattedValue())},this),e(this.Textbox).on("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler()):this.FormatOptions.eventHandler&&(e(this.Textbox).off("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler=null)},F.prototype.GetFormattedValue=function(){var t=this.GetValue();return"number"==typeof t&&(t="$"+r(t,this.FormatOptions.decimalPlaces)),t},F.prototype.MakeReadOnly=function(){return b(this,this.GetFormattedValue())},x.prototype=Object.create(m.prototype),x.prototype._getFillInValue=function(){return this.FillInTextbox.val()},x.prototype._setFillInValue=function(t){this.FillInTextbox.val(t)},g.prototype=Object.create(x.prototype),g.prototype.GetValue=function(){return this.FillInAllowed&&this.FillInElement.checked===!0?e(this.FillInTextbox).val():e(this.Dropdown).val()},g.prototype.SetValue=function(t){var n=e(this.Dropdown).find('option[value="'+t+'"]').length>0;return!n&&this.FillInAllowed?n?(e(this.Dropdown).val(t),this.FillInElement.checked=!1):(this.FillInElement.checked=!0,e(this.FillInTextbox).val(t)):n&&e(this.Dropdown).val(t),y(this),this},I.prototype=Object.create(x.prototype),I.prototype.GetValue=function(){var t=[];return e(this.Checkboxes).each(function(e,n){var o=n.value;o.checked===!0&&t.push(n.key)}),this.FillInAllowed&&this.FillInElement.checked===!0&&t.push(e(this.FillInTextbox).val()),t},I.prototype.SetValue=function(t,o){var l=null;return o=n(o)?!0:o,e(this.Checkboxes).each(function(e,n){return n.key===t?(l=n.value,!1):void 0}),null===l&&this.FillInAllowed&&(l=this.FillInElement,e(this.FillInTextbox).val(t)),null!==l&&(l.checked=o),y(this),this},C.prototype.IsValidDate=function(){return!n(this.Year)&&!n(this.Month)&&!n(this.Day)},C.prototype.IsValidHour=function(t){return!n(t)&&/^([1-9]|10|11|12) (AM|PM)$/.test(t)},C.prototype.IsValidMinute=function(t){return!n(t)&&/^([0-5](0|5))$/.test(t)},C.prototype.PadWithZero=function(t){return n(t)||null===t?"":o(t)&&(t=parseInt(t,10),isNaN(t))?"":"number"==typeof t&&10>t?"0"+(""+t):""+t},C.prototype.GetShortDateString=function(){if(!this.IsValidDate())return"";var t=this.PadWithZero(this.Month)+"/"+this.PadWithZero(this.Day)+"/"+this.PadWithZero(this.Year);return t},C.prototype.toString=function(){var t,e=this.GetShortDateString();return this.IsValidHour(this.Hour)&&this.IsValidMinute(this.Minute)&&(t=this.Hour.split(" "),e+=" "+t[0]+":"+this.Minute+t[1]),e},D.prototype=Object.create(m.prototype),D.prototype.GetValue=function(){var t,e,n,o=this.DateTextbox.val();return null!==this.HourDropdown&&null!==this.MinuteDropdown&&(t=this.HourDropdown.val(),e=this.MinuteDropdown.val()),n=o.split("/"),3===n.length?new C(n[2],n[0],n[1],t,e):""},D.prototype.SetValue=function(t,e,l,i,r){if(o(t)&&n(e))this.DateTextbox.val(t);else{var s=new C(t,e,l,i,r);this.DateTextbox.val(s.GetShortDateString()),null!==this.HourDropdown&&null!==this.MinuteDropdown&&(this.HourDropdown.val(s.Hour),this.MinuteDropdown.val(s.Minute))}return y(this),this};var R=function(t){this._defaults={debug:!1},this.settings=e.extend({},t,this._defaults)};R.GetSPField=M,R.Debug=O,t.SPUtility=R}(window,jQuery);