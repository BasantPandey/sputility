/*
   Name: SPUtility.js
   Version: 0.8.3 RC2
   Built: 2013-08-31
   Author: Kit Menke
   https://sputility.codeplex.com/
   Copyright (c) 2013
   License: Microsoft Public License (MS-PL)
*/
Object.create||(Object.create=function(t){function e(){}if(arguments.length>1)throw Error("Object.create implementation only accepts the first parameter.");return e.prototype=t,new e}),function(t,e){"use strict";function n(t){return t===void 0}function i(t){return"string"==typeof t}function o(t){return"number"==typeof t}function l(t){return parseInt(t,10)}function r(t){if("string"==typeof t){var e=t.match(/[0-9,.]+/g);null!==e&&(t=e[0].replace(/,/g,""),t=parseFloat(t))}return t}function s(t,e,n,i){e=isNaN(e=Math.abs(e))?2:e,n=void 0===n?".":n,i=void 0===i?",":i;var o=0>t?"-":"",l=parseInt(t=Math.abs(+t||0).toFixed(e),10)+"",r=(r=l.length)>3?r%3:0;return o+(r?l.substr(0,r)+i:"")+l.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+i)+(e?n+Math.abs(t-l).toFixed(e).slice(2):"")}function a(t){if(null===t.Controls)return null;var n=e(t.Controls).find("input");if(null!==n&&1===n.length)return n[0];throw"Unable to retrieve the input control for "+t.Name}function h(t,n){var i,o=[],l=e(t.Controls).find(n),r=e(t.Controls).find("label");if(r.length<l.length)throw"Unable to get hashtable of controls.";for(i=0;l.length>i;i++)o.push({key:e(r[i]).text(),value:l[i]});return o}function u(t,n){var i=null;return e(t).each(function(t,e){return e.key===n?(i=e.value,!1):void 0}),i}function p(t){var e,n,i;try{for(i=0;t.childNodes.length>i;i+=1)if(8===t.childNodes[i].nodeType){if(n=t.childNodes[i].data,e=n.match(/SPField\w+/),null!==e)return e[0];break}}catch(o){throw"getSPFieldType error: "+(""+o)}return null}function c(n){var i,o=null;switch(n.type){case"SPFieldText":o=new F(n);break;case"SPFieldNumber":o=new C(n);break;case"SPFieldCurrency":o=new k(n);break;case"SPFieldChoice":i=e(n.controlsCell).find("select"),o=i.length>0?new T(n,i):new D(n);break;case"SPFieldMultiChoice":o=new I(n);break;case"SPFieldDateTime":o=new V(n);break;case"SPFieldBoolean":o=new O(n);break;case"SPFieldUser":case"SPFieldUserMulti":o=new U(n);break;case"SPFieldURL":o=new R(n);break;case"SPFieldLookup":i=e(n.controlsCell).find("select"),i.length>0?o=new P(n,i):(i=e(n.controlsCell).find("input"),o=new L(n,i));break;case"SPFieldNote":if(i=e(n.controlsCell).find("textarea"),i.length>0?(i=i[0],o=t.RTE_GetEditorIFrame&&null!==t.RTE_GetEditorIFrame(i.id)?new G(n,i):new M(n,i)):(i=e(n.controlsCell).find('input[type="hidden"]'),i.length>=1&&(o=new N(n,i))),null===o)throw"Unknown type of SPFieldNote.";break;case"SPFieldFile":o=new H(n);break;case"SPFieldLookupMulti":o=new E(n);break;default:o=new m(n)}return o}function d(t){var n=null;try{if(null===t.controlsCell&&(t.controlsCell=e(t.labelCell).next()[0]),t.type=p(t.controlsCell),null===t.type)return null;n=c(t)}catch(i){throw"Error creating field named "+t.name+": "+(""+i)}return n}function f(t,i,o){var l,r,s=null,a="Unknown field";try{if(o)l=t;else if(l=e(t).children()[0],null===l||"NOBR"===l.nodeName)return null;a=e.trim(e(l).text()),r=a.lastIndexOf(" *")===a.length-2,!0===r&&(a=a.substring(0,a.length-2)),s={name:a,label:e(l),labelRow:e(t.parentNode),labelCell:t,isRequired:r,controlsRow:n(i)?null:e(i.parentNode),controlsCell:n(i)?null:i,type:null,spField:null}}catch(h){throw"getFieldParams error getting parameters for "+a+": "+(""+h)}return s}function y(){if(null===A){var t,n,i=e("table.ms-formtable td.ms-formlabel"),o=e("table.ms-formtable td.ms-formbodysurvey"),l=i.length;for($=o.length>0,A={},t=0;l>t;t+=1)n=f(i[t],o[t],$),null!==n&&(A[n.name]=n)}}function b(t,e,n){n?(t.show(),null!==e&&e.show()):(t.hide(),null!==e&&e.hide())}function x(t){t.ReadOnlyLabel&&t.ReadOnlyLabel.html(t.GetValue())}function v(t,n){try{e(t.Controls).hide(),null===t.ReadOnlyLabel&&(t.ReadOnlyLabel=e("<div/>").text(n).addClass("sputility-readonly"),e(t.Controls).after(t.ReadOnlyLabel)),t.ReadOnlyLabel.html(n),t.ReadOnlyLabel.show()}catch(i){throw"Error making "+t.Name+" read only. "+(""+i)}return t}function w(t){var n="";return t.each(function(){n+=e(this).text()+"; "}),n.length>2&&(n=n.substring(0,n.length-2)),n}function m(t){this.Label=t.label,this.LabelRow=t.labelRow,this.Name=t.name,this.IsRequired=t.isRequired,this.Type=t.type,this.Controls=e(t.controlsCell).children()[0],this.ControlsRow=t.controlsRow,this.ReadOnlyLabel=null}function F(t){m.call(this,t),this.Textbox=a(this)}function C(t){F.call(this,t)}function k(t){C.call(this,t),this.FormatOptions={eventHandler:null,autoCorrect:!1,decimalPlaces:2}}function g(t){if(m.call(this,t),null!==this.Controls){var n=e(this.Controls).find("input"),i=n.length;i>1&&"text"===n[i-1].type?(this.FillInTextbox=n[i-1],this.FillInElement=n[i-2],this.FillInAllowed=!0):(this.FillInAllowed=!1,this.FillInTextbox=null,this.FillInElement=null)}}function T(t,e){g.call(this,t),null!==this.Controls&&(this.Dropdown=e,this.Dropdown=1===this.Dropdown.length?this.Dropdown[0]:[])}function D(t){g.call(this,t),null!==this.Controls&&(this.RadioButtons=h(this,'input[type="radio"]'),this.FillInAllowed&&this.RadioButtons.pop())}function I(t){g.call(this,t),null!==this.Controls&&(this.Checkboxes=h(this,'input[type="checkbox"]'),this.FillInAllowed&&(this.FillInElement=this.Checkboxes.pop().value))}function S(t,e,i,o,l){if(this.Year=t,this.Month=e,this.Day=i,this.Hour=o,this.Minute=l,this.IsTimeIncluded=!n(this.Hour)&&!n(this.Minute),this.IsTimeIncluded){if(!this.IsValidHour(this.Hour))throw'Hour parameter is not in the correct format. Needs to be formatted like "1 PM" or "12 AM".';if(!this.IsValidMinute(this.Minute))throw'Minute parameter is not in the correct format. Needs to be formatted like "00", "05" or "35".'}}function V(t){if(m.call(this,t),this.DateTextbox=e(a(this)),this.HourDropdown=null,this.MinuteDropdown=null,this.IsDateOnly=!0,null!==this.Controls){var n=e(this.Controls).find("select");null!==n&&2===n.length&&(this.HourDropdown=e(n[0]),this.MinuteDropdown=e(n[1]),this.IsDateOnly=!1)}}function O(t){m.call(this,t),this.Checkbox=e(a(this))}function R(t){if(m.call(this,t),null!==this.Controls){this.TextboxURL=null,this.TextboxDescription=null;var n=e(this.Controls).find("input");null!==n&&2===n.length&&(this.TextboxURL=e(n[0]),this.TextboxDescription=e(n[1]))}}function P(t,e){if(m.call(this,t),null!==this.Controls){if(1!==e.length)throw"Unable to get dropdown element for "+this.Name;this.Dropdown=e[0]}}function L(t,n){if(m.call(this,t),null!==this.Controls){if(1!==n.length)throw"Unable to get input elements for "+this.Name;this.Textbox=e(n[0]),this.HiddenTextbox=e('input[id="'+this.Textbox.attr("optHid")+'"]')}}function M(t,e){m.call(this,t),this.Textbox=e,this.TextType="Plain"}function G(t,e){M.call(this,t,e),this.TextType="Rich"}function N(t,n){m.call(this,t),this.Textbox=n[0],this.ContentDiv=e(this.Controls).find('div[contenteditable="true"]')[0],this.TextType="Enhanced"}function H(t){F.call(this,t),this.FileExtension=e(this.Textbox).parent().text()}function E(t){if(m.call(this,t),null!==this.Controls){var n=e(this.Controls).find("select");if(2!==n.length)throw"Error initializing SPLookupMultiField named "+this.Name+", unable to get select controls.";this.ListChoices=n[0],this.ListSelections=n[1],n=e(this.Controls).find("button"),this.ButtonAdd=n[0],this.ButtonRemove=n[1]}}function U(i){if(m.call(this,i),null!==this.Controls){this.spanUserField=null,this.upLevelDiv=null,this.textareaDownLevelTextBox=null,this.linkCheckNames=null,this.txtHiddenSpanData=null;var o=e(this.Controls).find("span.ms-usereditor");if(null!==o&&1===o.length)this.spanUserField=o[0],this.upLevelDiv=e(this.spanUserField.id+"_upLevelDiv"),this.textareaDownLevelTextBox=e(this.spanUserField.id+"_downlevelTextBox"),this.linkCheckNames=e(this.spanUserField.id+"_checkNames"),this.txtHiddenSpanData=e(this.spanUserField.id+"_hiddenSpanData"),this.GetValue=function(){return this.upLevelDiv.text()},this.SetValue=function(t){return e.browser.msie?(this.upLevelDiv.innerHTML=t,this.txtHiddenSpanData.val(t),this.linkCheckNames.click()):(this.textareaDownLevelTextBox.val(t),this.linkCheckNames.onclick()),x(this),this};else if(!n(t.SPClientPeoplePicker)){var l=e(this.Controls).children()[0];this.ClientPeoplePicker=t.SPClientPeoplePicker.SPClientPeoplePickerDict[e(l).attr("id")],this.EditorInput=e(this.Controls).find("[id$='_EditorInput']")[0],this.HiddenInput=e(this.Controls).find("[id$='_HiddenInput']")[0],this.AutoFillDiv=e(this.Controls).find("[id$='_AutoFillDiv']")[0],this.ResolvedList=e(this.Controls).find("[id$='_ResolvedList']")[0],this.GetValue=function(){var t=e(this.ResolvedList).find("span.ms-entity-resolved");return t.length>0?w(t):""},this.SetValue=function(t){return this.ClientPeoplePicker.AddUserKeys(t,!1),x(this),this}}}}function j(t){return"boolean"==typeof t&&(B=t),B}function _(t){y();var e=A[t];if(n(e))throw"Unable to get a SPField named "+t;return null===e.spField&&(e.spField=d(e)),e.spField}var A=null,B=!1,$=!1;m.prototype.Show=function(){return b(this.LabelRow,this.ControlsRow,!0),this},m.prototype.Hide=function(){return b(this.LabelRow,this.ControlsRow,!1),this},m.prototype.MakeReadOnly=function(){return v(this,""+this.GetValue())},m.prototype.MakeEditable=function(){try{e(this.Controls).hide(),null!==this.ReadOnlyLabel&&e(this.ReadOnlyLabel).hide()}catch(t){alert("Error making "+this.Name+" editable. "+(""+t))}return this},m.prototype.toString=function(){return this.Name},m.prototype.GetValue=function(){throw"GetValue not yet implemented for "+this.Type+" in "+this.Name},m.prototype.SetValue=function(){throw"SetValue not yet implemented for "+this.Type+" in "+this.Name},F.prototype=Object.create(m.prototype),F.prototype.GetValue=function(){return e(this.Textbox).val()},F.prototype.SetValue=function(t){return e(this.Textbox).val(t),x(this),this},C.prototype=Object.create(F.prototype),C.prototype.GetValue=function(){return r(e(this.Textbox).val())},k.prototype=Object.create(C.prototype),k.prototype.Format=function(){this.FormatOptions.autoCorrect?(this.FormatOptions.eventHandler=e.proxy(function(){this.SetValue(this.GetFormattedValue())},this),e(this.Textbox).on("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler()):this.FormatOptions.eventHandler&&(e(this.Textbox).off("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler=null)},k.prototype.GetFormattedValue=function(){var t=this.GetValue();return"number"==typeof t&&(t="$"+s(t,this.FormatOptions.decimalPlaces)),t},k.prototype.MakeReadOnly=function(){return v(this,this.GetFormattedValue())},g.prototype=Object.create(m.prototype),g.prototype._getFillInValue=function(){return e(this.FillInTextbox).val()},g.prototype._setFillInValue=function(t){this.FillInElement.checked=!0,e(this.FillInTextbox).val(t)},T.prototype=Object.create(g.prototype),T.prototype.GetValue=function(){return this.FillInAllowed&&this.FillInElement.checked===!0?this._getFillInValue():e(this.Dropdown).val()},T.prototype.SetValue=function(t){var n=e(this.Dropdown).find('option[value="'+t+'"]').length>0;if(!n&&this.FillInAllowed)n?(e(this.Dropdown).val(t),this.FillInElement.checked=!1):this._setFillInValue(t);else{if(!n)throw"Unable to set value for "+this.Name+' the value "'+t+'" was not found.';e(this.Dropdown).val(t)}return x(this),this},D.prototype=Object.create(g.prototype),D.prototype.GetValue=function(){var t=null;return e(this.RadioButtons).each(function(e,n){var i=n.value;return i.checked?(t=n.key,!1):void 0}),this.FillInAllowed&&null===t&&this.FillInElement.checked===!0&&(t=e(this.FillInTextbox).val()),t},D.prototype.SetValue=function(t){var e=u(this.RadioButtons,t);if(null===e){if(!this.FillInAllowed)throw"Unable to set value for "+this.Name+' the value "'+t+'" was not found.';this._setFillInValue(t)}else e.checked=!0;return x(this),this},I.prototype=Object.create(g.prototype),I.prototype.GetValue=function(){var t=[];return e(this.Checkboxes).each(function(e,n){var i=n.value;i.checked&&t.push(n.key)}),this.FillInAllowed&&this.FillInElement.checked===!0&&t.push(e(this.FillInTextbox).val()),t},I.prototype.SetValue=function(t,i){var o=u(this.Checkboxes,t);if(i=n(i)?!0:i,null===o){if(!this.FillInAllowed)throw"Unable to set value for "+this.Name+' the value "'+t+'" was not found.';o=this.FillInElement,e(this.FillInTextbox).val(t),o.checked=!0}else o.checked=!0;return x(this),this},S.prototype.IsValidDate=function(){return!n(this.Year)&&!n(this.Month)&&!n(this.Day)},S.prototype.IsValidHour=function(t){return!n(t)&&/^([1-9]|10|11|12) (AM|PM)$/.test(t)},S.prototype.IsValidMinute=function(t){return!n(t)&&/^([0-5](0|5))$/.test(t)},S.prototype.PadWithZero=function(t){return n(t)||null===t?"":i(t)&&(t=l(t),isNaN(t))?"":"number"==typeof t&&10>t?"0"+(""+t):""+t},S.prototype.GetShortDateString=function(){if(!this.IsValidDate())return"";var t=this.PadWithZero(this.Month)+"/"+this.PadWithZero(this.Day)+"/"+this.PadWithZero(this.Year);return t},S.prototype.toString=function(){var t,e=this.GetShortDateString();return this.IsValidHour(this.Hour)&&this.IsValidMinute(this.Minute)&&(t=this.Hour.split(" "),e+=" "+t[0]+":"+this.Minute+t[1]),e},V.prototype=Object.create(m.prototype),V.prototype.GetValue=function(){var t,e,n,i=this.DateTextbox.val();return null!==this.HourDropdown&&null!==this.MinuteDropdown&&(t=this.HourDropdown.val(),e=this.MinuteDropdown.val()),n=i.split("/"),3===n.length?new S(n[2],n[0],n[1],t,e):""},V.prototype.SetValue=function(t,e,n,i,o){var l=new S(t,e,n,i,o);return this.DateTextbox.val(l.GetShortDateString()),null!==this.HourDropdown&&null!==this.MinuteDropdown&&(this.HourDropdown.val(l.Hour),this.MinuteDropdown.val(l.Minute)),x(this),this},O.prototype=Object.create(m.prototype),O.prototype.GetValue=function(){return!!this.Checkbox.val()},O.prototype.SetValue=function(t){return this.Checkbox.val(t),x(this),this},R.prototype=Object.create(m.prototype),R.prototype.GetValue=function(){return[this.TextboxURL.val(),this.TextboxDescription.val()]},R.prototype.SetValue=function(t,e){return this.TextboxURL.val(t),this.TextboxDescription.val(e),x(this),this},R.prototype.MakeReadOnly=function(t){var e,n=this.GetValue();return e=t&&!0===t.TextOnly?n[0]+", "+n[1]:'<a href="'+n[0]+'">'+n[1]+"</a>",v(this,e)},P.prototype=Object.create(m.prototype),P.prototype.GetValue=function(){return this.Dropdown.options[this.Dropdown.selectedIndex].text},P.prototype.SetValue=function(t){if(o(t))e(this.Dropdown).val(t);else{var n,i,l;for(i=this.Dropdown.options,n=0;i.length>n;n+=1)if(l=i[n],l.text===t){this.Dropdown.selectedIndex=n;break}}return x(this),this},L.prototype=Object.create(m.prototype),L.prototype.GetValue=function(){return this.Textbox.val()},L.prototype.SetValue=function(t){var e,n,i,o,r,s=[];for(e=this.Textbox.attr("choices"),e=e.split(/\|(?=\d+)/),s.push(e[0]),o=1;e.length-1>o;o++)r=e[o].indexOf("|"),s.push(e[o].substring(0,r)),s.push(e[o].substring(r+1));for(s.push(e[e.length-1]),t=t.replace("|","||"),o=0;s.length>o;o+=2)if(n=l(s[o+1]),i=s[o],t===n||t===i){this.Textbox.val(i);break}return null!==n&&this.HiddenTextbox.val(n),x(this),this},M.prototype=Object.create(m.prototype),M.prototype.GetValue=function(){return e(this.Textbox).val()},M.prototype.SetValue=function(t){return e(this.Textbox).val(t),x(this),this},G.prototype=Object.create(M.prototype),G.prototype.GetValue=function(){return t.RTE_GetIFrameContents(this.Textbox.id)},G.prototype.SetValue=function(n){return e(this.Textbox).val(n),t.RTE_TransferTextAreaContentsToIFrame(this.Textbox.id),x(this),this},N.prototype=Object.create(m.prototype),N.prototype.GetValue=function(){return e(this.ContentDiv).html()},N.prototype.SetValue=function(t){return e(this.ContentDiv).html(t),e(this.Textbox).val(t),x(this),this},H.prototype=Object.create(F.prototype),H.prototype.GetValue=function(){return e(this.Textbox).val()+this.FileExtension},E.prototype=Object.create(m.prototype),E.prototype.GetValue=function(){var t,e,n=[];for(e=this.ListSelections.options.length,t=0;e>t;t+=1)n.push(this.ListSelections.options[t].text);return n},E.prototype.MakeReadOnly=function(){return v(this,w(this.GetValue()))},E.prototype.SetValue=function(t,e){n(e)&&(e=!0);var i,l,r,s,a,h;for(e?(r=this.ListChoices.options,a=this.ButtonAdd.onclick):(r=this.ListSelections.options,a=this.ButtonRemove.onclick),s=r.length,o(t)?(t=""+t,h="value"):h="text",i=0;s>i;i+=1)l=r[i],l.selected=l[h]===t?!0:!1;return a(),x(this),this},U.prototype=Object.create(m.prototype);var W=function(t){this._defaults={debug:!1},this.settings=e.extend({},t,this._defaults)};W.GetSPField=_,W.Debug=j,t.SPUtility=W}(window,jQuery);