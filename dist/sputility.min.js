/*! SPUtility.js - v0.1.0 - 2013-08-25
* https://github.com/kitmenke/sputility
* Copyright (c) 2013 Kit Menke; Licensed MIT */
Object.create||(Object.create=function(t){function e(){}if(arguments.length>1)throw Error("Object.create implementation only accepts the first parameter.");return e.prototype=t,new e}),function(t,e){"use strict";function n(t){return t===void 0}function i(t){return"string"==typeof t}function l(t){if("string"==typeof t){var e=t.match(/[0-9,.]+/g);null!==e&&(t=e[0].replace(/,/g,""),t=parseFloat(t))}return t}function o(t,e,n,i){e=isNaN(e=Math.abs(e))?2:e,n=void 0===n?".":n,i=void 0===i?",":i;var l=0>t?"-":"",o=parseInt(t=Math.abs(+t||0).toFixed(e),10)+"",r=(r=o.length)>3?r%3:0;return l+(r?o.substr(0,r)+i:"")+o.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+i)+(e?n+Math.abs(t-o).toFixed(e).slice(2):"")}function r(t){if(null===t.Controls)return null;var n=e(t.Controls).find("input");if(null!==n&&1===n.length)return n[0];throw"Unable to retrieve the input control for "+t.Name}function s(t,n){var i,l=[],o=e(t.Controls).find(n),r=e(t.Controls).find("label");if(r.length<o.length)throw"Unable to get hashtable of controls.";for(i=0;o.length>i;i++)l.push({key:e(r[i]).text(),value:o[i]});return l}function a(t){var e,n,i;try{for(i=0;t.childNodes.length>i;i+=1)if(8===t.childNodes[i].nodeType){if(n=t.childNodes[i].data,e=n.match(/SPField\w+/),null!==e)return e[0];break}}catch(l){throw"getSPFieldType error: "+(""+l)}return null}function h(t){var e=null;switch(t.type){case"SPFieldText":e=new m(t);break;case"SPFieldNumber":e=new w(t);break;case"SPFieldCurrency":e=new x(t);break;case"SPFieldChoice":e=new C(t);break;case"SPFieldMultiChoice":e=new I(t);break;case"SPFieldDateTime":e=new D(t);break;case"SPFieldBoolean":e=new g(t);break;case"SPFieldUser":case"SPFieldUserMulti":e=new S(t);break;default:e=new v(t)}return e}function u(t){var n=null;try{if(null===t.controlsCell&&(t.controlsCell=e(t.labelCell).next()[0]),t.type=a(t.controlsCell),null===t.type)return null;n=h(t)}catch(i){throw"Error creating field named "+t.name+": "+(""+i)}return n}function c(t,i,l){var o,r,s=null,a="Unknown field";try{if(l)o=t;else if(o=e(t).children()[0],null===o||"NOBR"===o.nodeName)return null;a=e(o).text().trim(),r=a.lastIndexOf(" *")===a.length-2,!0===r&&(a=a.substring(0,a.length-2)),s={name:a,label:e(o),labelRow:e(t.parentNode),labelCell:t,isRequired:r,controlsRow:n(i)?null:e(i.parentNode),controlsCell:n(i)?null:i,type:null,spField:null}}catch(h){throw"getFieldParams error getting parameters for "+a+": "+(""+h)}return s}function p(){if(null===V){var t,n,i=e("table.ms-formtable td.ms-formlabel"),l=e("table.ms-formtable td.ms-formbodysurvey"),o=i.length;for(M=l.length>0,V={},t=0;o>t;t+=1)n=c(i[t],l[t],M),null!==n&&(V[n.name]=n)}}function d(t,e,n){n?(t.show(),null!==e&&e.show()):(t.hide(),null!==e&&e.hide())}function f(t){t.ReadOnlyLabel&&t.ReadOnlyLabel.html(t.GetValue())}function y(t,n){try{e(t.Controls).hide(),null===t.ReadOnlyLabel&&(t.ReadOnlyLabel=e("<div/>").text(n).addClass("sputility-readonly"),e(t.Controls).after(t.ReadOnlyLabel)),t.ReadOnlyLabel.html(n),t.ReadOnlyLabel.show()}catch(i){throw"Error making "+t.Name+" read only. "+(""+i)}return t}function b(t){var n="";return t.each(function(){n+=e(this).text()+"; "}),n.length>2&&(n=n.substring(0,n.length-2)),n}function v(t){this.Label=t.label,this.LabelRow=t.labelRow,this.Name=t.name,this.IsRequired=t.isRequired,this.Type=t.type,this.Controls=e(t.controlsCell).children()[0],this.ControlsRow=t.controlsRow,this.ReadOnlyLabel=null}function m(t){v.call(this,t),this.Textbox=r(this)}function w(t){m.call(this,t)}function x(t){w.call(this,t),this.FormatOptions={eventHandler:null,autoCorrect:!1,decimalPlaces:2}}function F(t){v.call(this,t),null!==this.Controls&&(this.FillInTextbox=e(this.Controls).find('input[type="text"]'),1===this.FillInTextbox.length?(this.FillInTextbox=this.FillInTextbox[0],this.FillInAllowed=!0,this.FillInElement=e(this.Controls).find('input[value="FillInButton"]')[0]):(this.FillInAllowed=!1,this.FillInTextbox=null,this.FillInElement=null))}function C(t){F.call(this,t),null!==this.Controls&&(this.Dropdown=e(this.Controls).find("select"),this.Dropdown=1===this.Dropdown.length?this.Dropdown[0]:[])}function I(t){F.call(this,t),null!==this.Controls&&(this.Checkboxes=s(this,'input[type="checkbox"]'),this.FillInAllowed&&(this.FillInElement=this.Checkboxes.pop().value))}function k(t,e,i,l,o){if(this.Year=t,this.Month=e,this.Day=i,this.Hour=l,this.Minute=o,this.IsTimeIncluded=!n(this.Hour)&&!n(this.Minute),this.IsTimeIncluded){if(!this.IsValidHour(this.Hour))throw'Hour parameter is not in the correct format. Needs to be formatted like "1 PM" or "12 AM".';if(!this.IsValidMinute(this.Minute))throw'Minute parameter is not in the correct format. Needs to be formatted like "00", "05" or "35".'}}function D(t){if(v.call(this,t),this.DateTextbox=e(r(this)),this.HourDropdown=null,this.MinuteDropdown=null,this.IsDateOnly=!0,null!==this.Controls){var n=e(this.Controls).find("select");null!==n&&2===n.length&&(this.HourDropdown=e(n[0]),this.MinuteDropdown=e(n[1]),this.IsDateOnly=!1)}}function g(t){v.call(this,t),this.Checkbox=e(r(this))}function S(i){if(v.call(this,i),null!==this.Controls){this.spanUserField=null,this.upLevelDiv=null,this.textareaDownLevelTextBox=null,this.linkCheckNames=null,this.txtHiddenSpanData=null;var l=e(this.Controls).find("span.ms-usereditor");if(null!==l&&1===l.length)this.spanUserField=l[0],this.upLevelDiv=e(this.spanUserField.id+"_upLevelDiv"),this.textareaDownLevelTextBox=e(this.spanUserField.id+"_downlevelTextBox"),this.linkCheckNames=e(this.spanUserField.id+"_checkNames"),this.txtHiddenSpanData=e(this.spanUserField.id+"_hiddenSpanData"),this.GetValue=function(){return this.upLevelDiv.text()},this.SetValue=function(t){return e.browser.msie?(this.upLevelDiv.innerHTML=t,this.txtHiddenSpanData.val(t),this.linkCheckNames.click()):(this.textareaDownLevelTextBox.val(t),this.linkCheckNames.onclick()),f(this),this};else if(!n(t.SPClientPeoplePicker)){var o=e(this.Controls).children()[0];this.ClientPeoplePicker=t.SPClientPeoplePicker.SPClientPeoplePickerDict[e(o).attr("id")],this.EditorInput=e(this.Controls).find("[id$='_EditorInput']")[0],this.HiddenInput=e(this.Controls).find("[id$='_HiddenInput']")[0],this.AutoFillDiv=e(this.Controls).find("[id$='_AutoFillDiv']")[0],this.ResolvedList=e(this.Controls).find("[id$='_ResolvedList']")[0],this.GetValue=function(){var t=e(this.ResolvedList).find("span.ms-entity-resolved");return t.length>0?b(t):""},this.SetValue=function(t){return this.ClientPeoplePicker.AddUserKeys(t,!1),f(this),this}}}}function O(t){return"boolean"==typeof t&&(T=t),T}function P(t){p();var e=V[t];if(n(e))throw"Unable to get a SPField named "+t;return null===e.spField&&(e.spField=u(e)),e.spField}var V=null,T=!1,M=!1;v.prototype.Show=function(){return d(this.LabelRow,this.ControlsRow,!0),this},v.prototype.Hide=function(){return d(this.LabelRow,this.ControlsRow,!1),this},v.prototype.MakeReadOnly=function(){return y(this,""+this.GetValue())},v.prototype.MakeEditable=function(){try{e(this.Controls).hide(),null!==this.ReadOnlyLabel&&e(this.ReadOnlyLabel).hide()}catch(t){alert("Error making "+this.Name+" editable. "+(""+t))}return this},v.prototype.toString=function(){return this.Name},v.prototype.GetValue=function(){throw"GetValue not yet implemented for "+this.Type+" in "+this.Name},v.prototype.SetValue=function(){throw"SetValue not yet implemented for "+this.Type+" in "+this.Name},m.prototype=Object.create(v.prototype),m.prototype.GetValue=function(){return e(this.Textbox).val()},m.prototype.SetValue=function(t){return e(this.Textbox).val(t),f(this),this},w.prototype=Object.create(m.prototype),w.prototype.GetValue=function(){return l(e(this.Textbox).val())},x.prototype=Object.create(w.prototype),x.prototype.Format=function(){this.FormatOptions.autoCorrect?(this.FormatOptions.eventHandler=e.proxy(function(){this.SetValue(this.GetFormattedValue())},this),e(this.Textbox).on("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler()):this.FormatOptions.eventHandler&&(e(this.Textbox).off("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler=null)},x.prototype.GetFormattedValue=function(){var t=this.GetValue();return"number"==typeof t&&(t="$"+o(t,this.FormatOptions.decimalPlaces)),t},x.prototype.MakeReadOnly=function(){return y(this,this.GetFormattedValue())},F.prototype=Object.create(v.prototype),F.prototype._getFillInValue=function(){return this.FillInTextbox.val()},F.prototype._setFillInValue=function(t){this.FillInTextbox.val(t)},C.prototype=Object.create(F.prototype),C.prototype.GetValue=function(){return this.FillInAllowed&&this.FillInElement.checked===!0?e(this.FillInTextbox).val():e(this.Dropdown).val()},C.prototype.SetValue=function(t){var n=e(this.Dropdown).find('option[value="'+t+'"]').length>0;return!n&&this.FillInAllowed?n?(e(this.Dropdown).val(t),this.FillInElement.checked=!1):(this.FillInElement.checked=!0,e(this.FillInTextbox).val(t)):n&&e(this.Dropdown).val(t),f(this),this},I.prototype=Object.create(F.prototype),I.prototype.GetValue=function(){var t=[];return e(this.Checkboxes).each(function(e,n){var i=n.value;i.checked===!0&&t.push(n.key)}),this.FillInAllowed&&this.FillInElement.checked===!0&&t.push(e(this.FillInTextbox).val()),t},I.prototype.SetValue=function(t,i){var l=null;return i=n(i)?!0:i,e(this.Checkboxes).each(function(e,n){return n.key===t?(l=n.value,!1):void 0}),null===l&&this.FillInAllowed&&(l=this.FillInElement,e(this.FillInTextbox).val(t)),null!==l&&(l.checked=i),f(this),this},k.prototype.IsValidDate=function(){return!n(this.Year)&&!n(this.Month)&&!n(this.Day)},k.prototype.IsValidHour=function(t){return!n(t)&&/^([1-9]|10|11|12) (AM|PM)$/.test(t)},k.prototype.IsValidMinute=function(t){return!n(t)&&/^([0-5](0|5))$/.test(t)},k.prototype.PadWithZero=function(t){return n(t)||null===t?"":i(t)&&(t=parseInt(t,10),isNaN(t))?"":"number"==typeof t&&10>t?"0"+(""+t):""+t},k.prototype.GetShortDateString=function(){if(!this.IsValidDate())return"";var t=this.PadWithZero(this.Month)+"/"+this.PadWithZero(this.Day)+"/"+this.PadWithZero(this.Year);return t},k.prototype.toString=function(){var t,e=this.GetShortDateString();return this.IsValidHour(this.Hour)&&this.IsValidMinute(this.Minute)&&(t=this.Hour.split(" "),e+=" "+t[0]+":"+this.Minute+t[1]),e},D.prototype=Object.create(v.prototype),D.prototype.GetValue=function(){var t,e,n,i=this.DateTextbox.val();return null!==this.HourDropdown&&null!==this.MinuteDropdown&&(t=this.HourDropdown.val(),e=this.MinuteDropdown.val()),n=i.split("/"),3===n.length?new k(n[2],n[0],n[1],t,e):""},D.prototype.SetValue=function(t,e,n,i,l){var o=new k(t,e,n,i,l);return this.DateTextbox.val(o.GetShortDateString()),null!==this.HourDropdown&&null!==this.MinuteDropdown&&(this.HourDropdown.val(o.Hour),this.MinuteDropdown.val(o.Minute)),f(this),this},g.prototype=Object.create(v.prototype),g.prototype.GetValue=function(){return!!this.Checkbox.val()},g.prototype.SetValue=function(t){return this.Checkbox.val(t),f(this),this},S.prototype=Object.create(v.prototype);var H=function(t){this._defaults={debug:!1},this.settings=e.extend({},t,this._defaults)};H.GetSPField=P,H.Debug=O,t.SPUtility=H}(window,jQuery);