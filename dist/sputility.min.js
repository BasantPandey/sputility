/*! SPUtility.js - v0.1.0 - 2013-04-21
* https://github.com/kitmenke/jquery.sputility
* Copyright (c) 2013 Kit Menke; Licensed MIT */
Object.create||(Object.create=function(t){function e(){}if(arguments.length>1)throw Error("Object.create implementation only accepts the first parameter.");return e.prototype=t,new e}),function(t,e){"use strict";function l(t){return t===void 0}function n(t,e){var n;if(k){if(e){t+="\r\n";for(n in e)e.hasOwnProperty(n)&&(t+=n+": "+e[n]+"\r\n")}l(console)?(T+=1,3===T&&(t="More than 3 errors (additional errors will not be shown):\r\n"+t),3>=T&&alert(t)):console.error(t)}}function o(t){if("string"==typeof t){var e=t.match(/[0-9,.]+/g);null!==e&&(t=e[0].replace(/,/g,""),t=parseFloat(t))}return t}function i(t,e,l,n){e=isNaN(e=Math.abs(e))?2:e,l=void 0===l?".":l,n=void 0===n?",":n;var o=0>t?"-":"",i=parseInt(t=Math.abs(+t||0).toFixed(e),10)+"",r=(r=i.length)>3?r%3:0;return o+(r?i.substr(0,r)+n:"")+i.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+n)+(e?l+Math.abs(t-i).toFixed(e).slice(2):"")}function r(t){if(null===t.Controls)return null;var l=e(t.Controls).find("input");if(null!==l&&1===l.length)return l[0];throw"Unable to retrieve the input control for "+t.Name}function a(t,l){var n,o=[],i=e(t.Controls).find(l),r=e(t.Controls).find("label");if(r.length<i.length)throw"Unable to get hashtable of controls.";for(n=0;i.length>n;n++)o.push({key:e(r[n]).text(),value:i[n]});return o}function s(t){var e,l,o;try{for(o=0;t.childNodes.length>o;o+=1)if(8===t.childNodes[o].nodeType){if(l=t.childNodes[o].data,e=l.match(/SPField\w+/),null!==e)return e[0];break}}catch(i){n("getSPFieldType: Error getting field type",i)}return null}function h(t){var e=null;switch(t.type){case"SPFieldText":e=new m(t);break;case"SPFieldNumber":e=new F(t);break;case"SPFieldCurrency":e=new w(t);break;case"SPFieldChoice":e=new x(t);break;case"SPFieldMultiChoice":e=new g(t);break;default:e=new b(t)}return e}function u(t){var l=null;try{if(null===t.controlsCell&&(t.controlsCell=e(t.labelCell).next()[0]),t.type=s(t.controlsCell),null===t.type)return null;l=h(t)}catch(o){n("createSPField: Error creating field for "+t.name,o)}return l}function c(t,o,i){var r,a,s=null,h="Unknown field";try{if(i)r=t;else if(r=e(t).children()[0],null===r||"NOBR"===r.nodeName)return null;h=e(r).text().trim(),a=h.lastIndexOf(" *")===h.length-2,!0===a&&(h=h.substring(0,h.length-2)),s={name:h,label:e(r),labelRow:e(t.parentNode),labelCell:t,isRequired:a,controlsRow:l(o)?null:e(o.parentNode),controlsCell:l(o)?null:o,type:null,spField:null}}catch(u){n("getFieldParams: Error getting field parameters "+h,u)}return s}function p(){if(null===I){var t,l,n=e("table.ms-formtable td.ms-formlabel"),o=e("table.ms-formtable td.ms-formbodysurvey"),i=n.length;for(R=o.length>0,I={},t=0;i>t;t+=1)l=c(n[t],o[t],R),null!==l&&(I[l.name]=l)}}function d(t,e,l){l?(t.show(),null!==e&&e.show()):(t.hide(),null!==e&&e.hide())}function f(t){t.ReadOnlyLabel&&t.ReadOnlyLabel.html(t.GetValue())}function y(t,l){try{e(t.Controls).hide(),null===t.ReadOnlyLabel&&(t.ReadOnlyLabel=e("<div/>").text(l).addClass("sputility-readonly"),e(t.Controls).after(t.ReadOnlyLabel)),t.ReadOnlyLabel.html(l),t.ReadOnlyLabel.show()}catch(o){n("Error making "+t.Name+" read only. "+(""+o))}return t}function b(t){this.Label=t.label,this.LabelRow=t.labelRow,this.Name=t.name,this.IsRequired=t.isRequired,this.Type=t.type,this.Controls=e(t.controlsCell).children()[0],this.ControlsRow=t.controlsRow,this.ReadOnlyLabel=null}function m(t){b.call(this,t),this.Textbox=r(this)}function F(t){m.call(this,t)}function w(t){F.call(this,t),this.FormatOptions={eventHandler:null,autoCorrect:!1,decimalPlaces:2}}function v(t){b.call(this,t),null!==this.Controls&&(this.FillInTextbox=e(this.Controls).find('input[type="text"]'),1===this.FillInTextbox.length?(this.FillInTextbox=this.FillInTextbox[0],this.FillInAllowed=!0,this.FillInElement=e(this.Controls).find('input[value="FillInButton"]')[0]):(this.FillInAllowed=!1,this.FillInTextbox=null,this.FillInElement=null))}function x(t){v.call(this,t),null!==this.Controls&&(this.Dropdown=e(this.Controls).find("select"),this.Dropdown=1===this.Dropdown.length?this.Dropdown[0]:[])}function g(t){v.call(this,t),null!==this.Controls&&(this.Checkboxes=a(this,'input[type="checkbox"]'),this.FillInAllowed&&(this.FillInElement=this.Checkboxes.pop().value))}function C(t){return"boolean"==typeof t&&(k=t),k}function O(t){p();var e=I[t];if(l(e))throw"Unable to get a SPField named "+t;return null===e.spField&&(e.spField=u(e)),e.spField}var I=null,k=!1,R=!1,T=0;b.prototype.Show=function(){return d(this.LabelRow,this.ControlsRow,!0),this},b.prototype.Hide=function(){return d(this.LabelRow,this.ControlsRow,!1),this},b.prototype.MakeReadOnly=function(){return y(this,""+this.GetValue())},b.prototype.MakeEditable=function(){try{e(this.Controls).hide(),null!==this.ReadOnlyLabel&&e(this.ReadOnlyLabel).hide()}catch(t){alert("Error making "+this.Name+" editable. "+(""+t))}return this},b.prototype.toString=function(){return this.Name},b.prototype.GetValue=function(){throw"GetValue not yet implemented for "+this.Type+" in "+this.Name},b.prototype.SetValue=function(){throw"SetValue not yet implemented for "+this.Type+" in "+this.Name},m.prototype=Object.create(b.prototype),m.prototype.GetValue=function(){return e(this.Textbox).val()},m.prototype.SetValue=function(t){return e(this.Textbox).val(t),f(this),this},F.prototype=Object.create(m.prototype),F.prototype.GetValue=function(){return o(e(this.Textbox).val())},w.prototype=Object.create(F.prototype),w.prototype.Format=function(){this.FormatOptions.autoCorrect?(this.FormatOptions.eventHandler=e.proxy(function(){this.SetValue(this.GetFormattedValue())},this),e(this.Textbox).on("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler()):this.FormatOptions.eventHandler&&(e(this.Textbox).off("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler=null)},w.prototype.GetFormattedValue=function(){var t=this.GetValue();return"number"==typeof t&&(t="$"+i(t,this.FormatOptions.decimalPlaces)),t},w.prototype.MakeReadOnly=function(){return y(this,this.GetFormattedValue())},v.prototype=Object.create(b.prototype),v.prototype._getFillInValue=function(){return this.FillInTextbox.val()},v.prototype._setFillInValue=function(t){this.FillInTextbox.val(t)},x.prototype=Object.create(v.prototype),x.prototype.GetValue=function(){return this.FillInAllowed&&this.FillInElement.checked===!0?e(this.FillInTextbox).val():e(this.Dropdown).val()},x.prototype.SetValue=function(t){var l=e(this.Dropdown).find('option[value="'+t+'"]').length>0;return!l&&this.FillInAllowed?l?(e(this.Dropdown).val(t),this.FillInElement.checked=!1):(this.FillInElement.checked=!0,e(this.FillInTextbox).val(t)):l&&e(this.Dropdown).val(t),f(this),this},g.prototype=Object.create(v.prototype),g.prototype.GetValue=function(){var t=[];return e(this.Checkboxes).each(function(e,l){var n=l.value;n.checked===!0&&t.push(l.key)}),this.FillInAllowed&&this.FillInElement.checked===!0&&t.push(e(this.FillInTextbox).val()),t},g.prototype.SetValue=function(t,n){var o=null;return n=l(n)?!0:n,e(this.Checkboxes).each(function(e,l){return l.key===t?(o=l.value,!1):void 0}),null===o&&this.FillInAllowed&&(o=this.FillInElement,e(this.FillInTextbox).val(t)),null!==o&&(o.checked=n),f(this),this},e.sputility=C,e.spfield=O}(window,jQuery);