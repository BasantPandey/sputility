/*
   Name: SPUtility.js
   Version: 0.9.0
   Built: 2014-04-02
   Author: Kit Menke
   https://sputility.codeplex.com/
   Copyright (c) 2014
   License: Microsoft Public License (MS-PL)
*/
Object.create||(Object.create=function(a){function b(){}if(arguments.length>1)throw new Error("Object.create implementation only accepts the first parameter.");return b.prototype=a,new b});var SPUtility=function(a){"use strict";function b(a){return"undefined"==typeof a}function c(a){return"string"==typeof a}function d(a){return"number"==typeof a}function e(a){return parseInt(a,10)}function f(a){if("string"==typeof a){var b=a.match(/[0-9,.]+/g);null!==b&&(a=b[0].replace(/,/g,""),a=parseFloat(a))}return a}function g(a,b,c,d){b=isNaN(b=Math.abs(b))?2:b,c=void 0===c?".":c,d=void 0===d?",":d;var e=0>a?"-":"",f=parseInt(a=Math.abs(+a||0).toFixed(b),10)+"",g=(g=f.length)>3?g%3:0;return e+(g?f.substr(0,g)+d:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+d)+(b?c+Math.abs(a-f).toFixed(b).slice(2):"")}function h(b){if(null===b.Controls)return null;var c=a(b.Controls).find("input");if(null!==c&&1===c.length)return c[0];throw"Unable to retrieve the input control for "+b.Name}function i(b,c){var d,e=[],f=a(b.Controls).find(c),g=a(b.Controls).find("label");if(g.length<f.length)throw"Unable to get hashtable of controls.";for(d=0;d<f.length;d++)e.push({key:a(g[d]).text(),value:f[d]});return e}function j(b,c){var d=null;return a(b).each(function(a,b){return b.key===c?(d=b.value,!1):void 0}),d}function k(a){var b,c,d;try{for(d=0;d<a.childNodes.length;d+=1)if(8===a.childNodes[d].nodeType){if(c=a.childNodes[d].data,b=c.match(/SPField\w+/),null!==b)return b[0];break}}catch(e){throw"getSPFieldType error: "+e.toString()}return null}function l(b){var c,d=null;switch(b.type){case"SPFieldText":d=new t(b);break;case"SPFieldNumber":d=new u(b);break;case"SPFieldCurrency":d=new v(b);break;case"SPFieldChoice":c=a(b.controlsCell).find("select"),d=c.length>0?new x(b,c):new y(b);break;case"SPFieldMultiChoice":d=new z(b);break;case"SPFieldDateTime":d=new B(b);break;case"SPFieldBoolean":d=new C(b);break;case"SPFieldUser":case"SPFieldUserMulti":d=new L(b);break;case"SPFieldURL":d=new D(b);break;case"SPFieldLookup":c=a(b.controlsCell).find("select"),c.length>0?d=new E(b,c):(c=a(b.controlsCell).find("input"),d=new F(b,c));break;case"SPFieldNote":c=a(b.controlsCell).find("textarea"),c.length>0?(c=c[0],window.RTE_GetEditorIFrame&&null!==window.RTE_GetEditorIFrame(c.id)&&(d=new H(b,c))):(c=a(b.controlsCell).find('input[type="hidden"]'),c.length>=1&&(d=new I(b,c))),null===d&&(d=new G(b,c));break;case"SPFieldFile":d=new J(b);break;case"SPFieldLookupMulti":d=new K(b);break;default:d=new s(b)}return d}function m(b){var c=null;try{if(null===b.controlsCell&&(b.controlsCell=a(b.labelCell).next()[0]),b.type=k(b.controlsCell),null===b.type)return null;c=l(b)}catch(d){throw"Error creating field named "+b.name+": "+d.toString()}return c}function n(c,d,e){var f,g,h=null,i="Unknown field";try{if(e)f=c;else if(f=a(c).children()[0],null===f||"NOBR"===f.nodeName)return null;i=a.trim(a(f).text()),g=i.lastIndexOf(" *")===i.length-2,!0===g&&(i=i.substring(0,i.length-2)),h={name:i,label:a(f),labelRow:a(c.parentNode),labelCell:c,isRequired:g,controlsRow:b(d)?null:a(d.parentNode),controlsCell:b(d)?null:d,type:null,spField:null}}catch(j){throw"getFieldParams error getting parameters for "+i+": "+j.toString()}return h}function o(){if(null===M){var b,c,d=a("table.ms-formtable td.ms-formlabel"),e=a("table.ms-formtable td.ms-formbodysurvey"),f=d.length;for(N=e.length>0,M={},b=0;f>b;b+=1)c=n(d[b],e[b],N),null!==c&&(M[c.name]=c)}}function p(b,c,d){d?(a(b).show(),null!==c&&a(c).show()):(a(b).hide(),null!==c&&a(c).hide())}function q(a,c){o();var d=M[a];if(b(d))throw"toggleSPField: Unable to find a SPField named "+a+" - "+c;p(d.labelRow,d.controlsRow,c)}function r(b){var c="";return a(b).each(function(b,d){c+=a(d).text()+"; "}),c.length>2&&(c=c.substring(0,c.length-2)),c}function s(b){this.Label=b.label,this.LabelRow=b.labelRow,this.Name=b.name,this.IsRequired=b.isRequired,this.Type=b.type,this.Controls=a(b.controlsCell).children().length>0?a(b.controlsCell).children()[0]:null,this.ControlsRow=b.controlsRow,this.ReadOnlyLabel=null}function t(a){s.call(this,a),this.Textbox=h(this)}function u(a){t.call(this,a)}function v(a){u.call(this,a),this.FormatOptions={eventHandler:null,autoCorrect:!1,decimalPlaces:2}}function w(b){if(s.call(this,b),null!==this.Controls){var c=a(this.Controls).find("input"),d=c.length;d>1&&"text"===c[d-1].type?(this.FillInTextbox=c[d-1],this.FillInElement=c[d-2],this.FillInAllowed=!0):(this.FillInAllowed=!1,this.FillInTextbox=null,this.FillInElement=null)}}function x(a,b){w.call(this,a),null!==this.Controls&&(this.Dropdown=b,this.Dropdown=1===this.Dropdown.length?this.Dropdown[0]:[])}function y(a){w.call(this,a),null!==this.Controls&&(this.RadioButtons=i(this,'input[type="radio"]'),this.FillInAllowed&&this.RadioButtons.pop())}function z(a){w.call(this,a),null!==this.Controls&&(this.Checkboxes=i(this,'input[type="checkbox"]'),this.FillInAllowed&&(this.FillInElement=this.Checkboxes.pop().value))}function A(a,e,f,g,h){if(this.Year=a,this.Month=e,this.Day=f,this.IsTimeIncluded=!b(g)&&!b(h),this.Hour="12 AM",this.HourInt=0,this.Minute="00",this.IsTimeIncluded){if(d(g)){if(0>g||g>23)throw"Hour number parameter must be between 0 and 23.";this.Hour=this.ConvertHourToString(g),this.HourInt=g}else if(c(g)){if(!this.IsValidHour(g))throw'Hour string parameter must be formatted like "1 PM" or "12 AM".';this.Hour=g,this.HourInt=this.ConvertHourToNumber(g)}if(!this.IsValidMinute(h))throw'Minute parameter is not in the correct format. Needs to be formatted like "00", "05" or "35".';this.Minute=h}}function B(b){if(s.call(this,b),this.DateTextbox=h(this),this.HourDropdown=null,this.MinuteDropdown=null,this.IsDateOnly=!0,this.HourValueFormat=null,null!==this.Controls){var c=a(this.Controls).find("select");null!==c&&2===c.length&&(this.HourDropdown=c[0],this.HourValueFormat=a(this.HourDropdown).val().indexOf(" ")>-1?"string":"number",this.MinuteDropdown=c[1],this.IsDateOnly=!1)}}function C(b){s.call(this,b),this.Checkbox=a(h(this))}function D(b){if(s.call(this,b),null!==this.Controls){this.TextboxURL=null,this.TextboxDescription=null,this.TextOnly=!1;var c=a(this.Controls).find("input");null!==c&&2===c.length&&(this.TextboxURL=a(c[0]),this.TextboxDescription=a(c[1]))}}function E(a,b){if(s.call(this,a),null!==this.Controls){if(1!==b.length)throw"Unable to get dropdown element for "+this.Name;this.Dropdown=b[0]}}function F(b,c){if(s.call(this,b),null!==this.Controls){if(1!==c.length)throw"Unable to get input elements for "+this.Name;this.Textbox=a(c[0]),this.HiddenTextbox=a('input[id="'+this.Textbox.attr("optHid")+'"]')}}function G(a,b){s.call(this,a),this.Textbox=b,this.TextType="Plain"}function H(a,b){G.call(this,a,b),this.TextType="Rich"}function I(b,c){s.call(this,b),this.Textbox=c[0],this.ContentDiv=a(this.Controls).find('div[contenteditable="true"]')[0],this.TextType="Enhanced"}function J(b){t.call(this,b),this.FileExtension=a(this.Textbox).parent().text()}function K(b){if(s.call(this,b),null!==this.Controls){var c=a(this.Controls).find("select");if(2!==c.length)throw"Error initializing SPLookupMultiField named "+this.Name+", unable to get select controls.";this.ListChoices=c[0],this.ListSelections=c[1],c=a(this.Controls).find("button"),0===c.length&&(c=a(this.Controls).find('input[type="button"]')),this.ButtonAdd=c[0],this.ButtonRemove=c[1]}}function L(c){if(s.call(this,c),null!==this.Controls){this.spanUserField=null,this.upLevelDiv=null,this.textareaDownLevelTextBox=null,this.linkCheckNames=null,this.txtHiddenSpanData=null;var d=a(this.Controls).find("span.ms-usereditor");if(null!==d&&1===d.length)this.spanUserField=d[0],this.upLevelDiv=a(this.spanUserField.id+"_upLevelDiv"),this.textareaDownLevelTextBox=a(this.spanUserField.id+"_downlevelTextBox"),this.linkCheckNames=a(this.spanUserField.id+"_checkNames"),this.txtHiddenSpanData=a(this.spanUserField.id+"_hiddenSpanData"),this.GetValue=function(){return this.upLevelDiv.text()},this.SetValue=function(b){return a.browser.msie?(this.upLevelDiv.innerHTML=b,this.txtHiddenSpanData.val(b),this.linkCheckNames.click()):(this.textareaDownLevelTextBox.val(b),this.linkCheckNames.onclick()),this._updateReadOnlyLabel(this.GetValue()),this};else if(!b(window.SPClientPeoplePicker)){var e=a(this.Controls).children()[0];this.ClientPeoplePicker=window.SPClientPeoplePicker.SPClientPeoplePickerDict[a(e).attr("id")],this.EditorInput=a(this.Controls).find("[id$='_EditorInput']")[0],this.HiddenInput=a(this.Controls).find("[id$='_HiddenInput']")[0],this.AutoFillDiv=a(this.Controls).find("[id$='_AutoFillDiv']")[0],this.ResolvedList=a(this.Controls).find("[id$='_ResolvedList']")[0],this.GetValue=function(){var b=a(this.ResolvedList).find("span.ms-entity-resolved");return b.length>0?r(b):""},this.SetValue=function(a){return this.ClientPeoplePicker.AddUserKeys(a,!1),this._updateReadOnlyLabel(this.GetValue()),this}}}}var M=null,N=!1;s.prototype.Show=function(){return p(this.LabelRow,this.ControlsRow,!0),this},s.prototype.Hide=function(){return p(this.LabelRow,this.ControlsRow,!1),this},s.prototype._updateReadOnlyLabel=function(a){this.ReadOnlyLabel&&this.ReadOnlyLabel.html(a)},s.prototype._makeReadOnly=function(b){try{a(this.Controls).hide(),null===this.ReadOnlyLabel&&(this.ReadOnlyLabel=a("<div/>").addClass("sputility-readonly"),a(this.Controls).after(this.ReadOnlyLabel)),this.ReadOnlyLabel.html(b),this.ReadOnlyLabel.show()}catch(c){throw"Error making "+this.Name+" read only. "+c.toString()}return this},s.prototype.MakeReadOnly=function(){return this._makeReadOnly(this.GetValue().toString())},s.prototype.MakeEditable=function(){try{a(this.Controls).show(),null!==this.ReadOnlyLabel&&a(this.ReadOnlyLabel).hide()}catch(b){throw"Error making "+this.Name+" editable. "+b.toString()}return this},s.prototype.toString=function(){return this.Name},s.prototype.GetValue=function(){throw"GetValue not yet implemented for "+this.Type+" in "+this.Name},s.prototype.SetValue=function(){throw"SetValue not yet implemented for "+this.Type+" in "+this.Name},t.prototype=Object.create(s.prototype),t.prototype.GetValue=function(){return a(this.Textbox).val()},t.prototype.SetValue=function(b){return a(this.Textbox).val(b),this._updateReadOnlyLabel(this.GetValue().toString()),this},u.prototype=Object.create(t.prototype),u.prototype.GetValue=function(){return f(a(this.Textbox).val())},v.prototype=Object.create(u.prototype),v.prototype.Format=function(){this.FormatOptions.autoCorrect?(this.FormatOptions.eventHandler=a.proxy(function(){this.SetValue(this.GetFormattedValue())},this),a(this.Textbox).on("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler()):this.FormatOptions.eventHandler&&(a(this.Textbox).off("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler=null)},v.prototype.GetFormattedValue=function(){var a=this.GetValue();return"number"==typeof a&&(a="$"+g(a,this.FormatOptions.decimalPlaces)),a},v.prototype.SetValue=function(b){return a(this.Textbox).val(b),this._updateReadOnlyLabel(this.GetFormattedValue()),this},v.prototype.MakeReadOnly=function(){return this._makeReadOnly(this.GetFormattedValue())},w.prototype=Object.create(s.prototype),w.prototype._getFillInValue=function(){return a(this.FillInTextbox).val()},w.prototype._setFillInValue=function(b){this.FillInElement.checked=!0,a(this.FillInTextbox).val(b)},x.prototype=Object.create(w.prototype),x.prototype.GetValue=function(){return this.FillInAllowed&&this.FillInElement.checked===!0?this._getFillInValue():a(this.Dropdown).val()},x.prototype.SetValue=function(b){var c=a(this.Dropdown).find('option[value="'+b+'"]').length>0;if(!c&&this.FillInAllowed)c?(a(this.Dropdown).val(b),this.FillInElement.checked=!1):this._setFillInValue(b);else{if(!c)throw"Unable to set value for "+this.Name+' the value "'+b+'" was not found.';a(this.Dropdown).val(b)}return this._updateReadOnlyLabel(this.GetValue().toString()),this},y.prototype=Object.create(w.prototype),y.prototype.GetValue=function(){var b=null;return a(this.RadioButtons).each(function(a,c){var d=c.value;return d.checked?(b=c.key,!1):void 0}),this.FillInAllowed&&null===b&&this.FillInElement.checked===!0&&(b=a(this.FillInTextbox).val()),b},y.prototype.SetValue=function(a){var b=j(this.RadioButtons,a);if(null===b){if(!this.FillInAllowed)throw"Unable to set value for "+this.Name+' the value "'+a+'" was not found.';this._setFillInValue(a)}else b.checked=!0;return this._updateReadOnlyLabel(this.GetValue().toString()),this},z.prototype=Object.create(w.prototype),z.prototype.MakeReadOnly=function(){return this._makeReadOnly(this.GetValue().join("; "))},z.prototype.GetValue=function(){var b=[];return a(this.Checkboxes).each(function(a,c){var d=c.value;d.checked&&b.push(c.key)}),this.FillInAllowed&&this.FillInElement.checked===!0&&b.push(a(this.FillInTextbox).val()),b},z.prototype.SetValue=function(c,d){var e=j(this.Checkboxes,c);if(d=b(d)?!0:d,null===e){if(!this.FillInAllowed)throw"Unable to set value for "+this.Name+' the value "'+c+'" was not found.';e=this.FillInElement,a(this.FillInTextbox).val(c),e.checked=!0}else e.checked=!0;return this._updateReadOnlyLabel(this.GetValue().join("; ")),this},A.prototype.IsValidDate=function(){return!b(this.Year)&&!b(this.Month)&&!b(this.Day)},A.prototype.IsValidHour=function(a){return!b(a)&&/^([1-9]|10|11|12) (AM|PM)$/.test(a)},A.prototype.IsValidMinute=function(a){return!b(a)&&/^([0-5](0|5))$/.test(a)},A.prototype.ConvertHourToString=function(a){var b;return b=0===a?"12 AM":a>12?(a-12).toString()+" PM":a.toString()+" AM"},A.prototype.ConvertHourToNumber=function(a){var b;return a=a.split(" "),b=e(a[0]),"AM"===a[1]?12===b&&(b=0):"PM"===a[1]&&(b+=12),b},A.prototype.PadWithZero=function(a){return b(a)||null===a?"":c(a)&&(a=e(a),isNaN(a))?"":"number"==typeof a&&10>a?"0"+a.toString():a.toString()},A.prototype.GetShortDateString=function(){if(!this.IsValidDate())return"";var a=this.PadWithZero(this.Month)+"/"+this.PadWithZero(this.Day)+"/"+this.PadWithZero(this.Year);return a},A.prototype.toString=function(){var a,b=this.GetShortDateString();return this.IsTimeIncluded&&this.IsValidHour(this.Hour)&&this.IsValidMinute(this.Minute)&&(a=this.Hour.split(" "),b+=" "+a[0]+":"+this.Minute+a[1]),b},B.prototype=Object.create(s.prototype),B.prototype.GetValue=function(){var b,c,d=a(this.DateTextbox).val().split("/");return this.IsDateOnly||(b=a(this.HourDropdown).val(),"number"===this.HourValueFormat&&(b=e(b)),c=a(this.MinuteDropdown).val()),3===d.length?new A(d[2],d[0],d[1],b,c):""},B.prototype.SetValue=function(b,c,d,e,f){var g=new A(b,c,d,e,f);return a(this.DateTextbox).val(g.GetShortDateString()),null!==this.HourDropdown&&null!==this.MinuteDropdown&&(a(this.HourDropdown).val("string"===this.HourValueFormat?g.Hour:g.HourInt),a(this.MinuteDropdown).val(g.Minute)),this._updateReadOnlyLabel(this.GetValue().toString()),this},C.prototype=Object.create(s.prototype),C.prototype.GetValue=function(){return!!this.Checkbox.val()},C.prototype.SetValue=function(a){return this.Checkbox.val(a),this._updateReadOnlyLabel(this.GetValue().toString()),this},D.prototype=Object.create(s.prototype),D.prototype.GetValue=function(){return[this.TextboxURL.val(),this.TextboxDescription.val()]},D.prototype.SetValue=function(a,b){return this.TextboxURL.val(a),this.TextboxDescription.val(b),this._updateReadOnlyLabel(this.GetHyperlink()),this},D.prototype.GetHyperlink=function(){var a,b=this.GetValue();return a=this.TextOnly?b[0]+", "+b[1]:'<a href="'+b[0]+'">'+b[1]+"</a>"},D.prototype.MakeReadOnly=function(a){return a&&!0===a.TextOnly&&(this.TextOnly=!0),this._makeReadOnly(this.GetHyperlink())},E.prototype=Object.create(s.prototype),E.prototype.GetValue=function(){return this.Dropdown.options[this.Dropdown.selectedIndex].text},E.prototype.SetValue=function(b){if(d(b))a(this.Dropdown).val(b);else{var c,e,f;for(e=this.Dropdown.options,c=0;c<e.length;c+=1)if(f=e[c],f.text===b){this.Dropdown.selectedIndex=c;break}}return this._updateReadOnlyLabel(this.GetValue()),this},F.prototype=Object.create(s.prototype),F.prototype.GetValue=function(){return this.Textbox.val()},F.prototype.SetValue=function(a){var b,d,f,g,h,i=[];for(b=this.Textbox.attr("choices"),b=b.split(/\|(?=\d+)/),i.push(b[0]),g=1;g<b.length-1;g++)h=b[g].indexOf("|"),i.push(b[g].substring(0,h)),i.push(b[g].substring(h+1));for(i.push(b[b.length-1]),c(a)&&(a=a.replace("|","||")),g=0;g<i.length;g+=2)if(d=e(i[g+1]),f=i[g],a===d||a===f){this.Textbox.val(f.replace("||","|"));break}return null!==d&&this.HiddenTextbox.val(d),this._updateReadOnlyLabel(this.GetValue()),this},G.prototype=Object.create(s.prototype),G.prototype.GetValue=function(){return a(this.Textbox).val()},G.prototype.SetValue=function(b){return a(this.Textbox).val(b),this._updateReadOnlyLabel(this.GetValue()),this},H.prototype=Object.create(G.prototype),H.prototype.GetValue=function(){return window.RTE_GetIFrameContents(this.Textbox.id)},H.prototype.SetValue=function(b){return a(this.Textbox).val(b),window.RTE_TransferTextAreaContentsToIFrame(this.Textbox.id),this._updateReadOnlyLabel(this.GetValue()),this},I.prototype=Object.create(s.prototype),I.prototype.GetValue=function(){return a(this.ContentDiv).html()},I.prototype.SetValue=function(b){return a(this.ContentDiv).html(b),a(this.Textbox).val(b),this._updateReadOnlyLabel(this.GetValue()),this},J.prototype=Object.create(t.prototype),J.prototype.GetValue=function(){return a(this.Textbox).val()+this.FileExtension},K.prototype=Object.create(s.prototype),K.prototype.GetValue=function(){var a,b,c=[];for(b=this.ListSelections.options.length,a=0;b>a;a+=1)c.push(this.ListSelections.options[a].text);return c},K.prototype.MakeReadOnly=function(){return this._makeReadOnly(this.GetValue().join("; "))},K.prototype.SetValue=function(c,e){b(e)&&(e=!0);var f,g,h,i,j,k;for(e?(h=this.ListChoices.options,j=this.ButtonAdd):(h=this.ListSelections.options,j=this.ButtonRemove),i=h.length,d(c)?(c=c.toString(),k="value"):k="text",f=0;i>f;f+=1)g=h[f],g.selected=g[k]===c?!0:!1;return j.disabled="",a(j).click(),this._updateReadOnlyLabel(this.GetValue().join("; ")),this},L.prototype=Object.create(s.prototype);var O={};return O.Debug=function(){return!1},O.GetSPField=function(a){o();var c=M[a];if(b(c))throw"Unable to get a SPField named "+a;return null===c.spField&&(c.spField=m(c)),c.spField},O.GetSPFields=function(){return o(),M},O.HideSPField=function(a){q(a,!1)},O.ShowSPField=function(a){q(a,!0)},O}(jQuery);