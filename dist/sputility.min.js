/*
   Name: SPUtility.js
   Version: 0.8.4
   Built: 2014-02-08
   Author: Kit Menke
   https://sputility.codeplex.com/
   Copyright (c) 2014
   License: Microsoft Public License (MS-PL)
*/
Object.create||(Object.create=function(t){function e(){}if(arguments.length>1)throw Error("Object.create implementation only accepts the first parameter.");return e.prototype=t,new e}),function(t,e){"use strict";function n(t){return t===void 0}function i(t){return"string"==typeof t}function o(t){return"number"==typeof t}function l(t){return parseInt(t,10)}function r(t){if("string"==typeof t){var e=t.match(/[0-9,.]+/g);null!==e&&(t=e[0].replace(/,/g,""),t=parseFloat(t))}return t}function s(t,e,n,i){e=isNaN(e=Math.abs(e))?2:e,n=void 0===n?".":n,i=void 0===i?",":i;var o=0>t?"-":"",l=parseInt(t=Math.abs(+t||0).toFixed(e),10)+"",r=(r=l.length)>3?r%3:0;return o+(r?l.substr(0,r)+i:"")+l.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+i)+(e?n+Math.abs(t-l).toFixed(e).slice(2):"")}function a(t){if(null===t.Controls)return null;var n=e(t.Controls).find("input");if(null!==n&&1===n.length)return n[0];throw"Unable to retrieve the input control for "+t.Name}function h(t,n){var i,o=[],l=e(t.Controls).find(n),r=e(t.Controls).find("label");if(r.length<l.length)throw"Unable to get hashtable of controls.";for(i=0;l.length>i;i++)o.push({key:e(r[i]).text(),value:l[i]});return o}function u(t,n){var i=null;return e(t).each(function(t,e){return e.key===n?(i=e.value,!1):void 0}),i}function p(t){var e,n,i;try{for(i=0;t.childNodes.length>i;i+=1)if(8===t.childNodes[i].nodeType){if(n=t.childNodes[i].data,e=n.match(/SPField\w+/),null!==e)return e[0];break}}catch(o){throw"getSPFieldType error: "+(""+o)}return null}function c(n){var i,o=null;switch(n.type){case"SPFieldText":o=new F(n);break;case"SPFieldNumber":o=new C(n);break;case"SPFieldCurrency":o=new g(n);break;case"SPFieldChoice":i=e(n.controlsCell).find("select"),o=i.length>0?new k(n,i):new I(n);break;case"SPFieldMultiChoice":o=new D(n);break;case"SPFieldDateTime":o=new S(n);break;case"SPFieldBoolean":o=new O(n);break;case"SPFieldUser":case"SPFieldUserMulti":o=new U(n);break;case"SPFieldURL":o=new H(n);break;case"SPFieldLookup":i=e(n.controlsCell).find("select"),i.length>0?o=new R(n,i):(i=e(n.controlsCell).find("input"),o=new P(n,i));break;case"SPFieldNote":if(i=e(n.controlsCell).find("textarea"),i.length>0?(i=i[0],o=t.RTE_GetEditorIFrame&&null!==t.RTE_GetEditorIFrame(i.id)?new M(n,i):new L(n,i)):(i=e(n.controlsCell).find('input[type="hidden"]'),i.length>=1&&(o=new N(n,i))),null===o)throw"Unknown type of SPFieldNote.";break;case"SPFieldFile":o=new G(n);break;case"SPFieldLookupMulti":o=new E(n);break;default:o=new w(n)}return o}function d(t){var n=null;try{if(null===t.controlsCell&&(t.controlsCell=e(t.labelCell).next()[0]),t.type=p(t.controlsCell),null===t.type)return null;n=c(t)}catch(i){throw"Error creating field named "+t.name+": "+(""+i)}return n}function f(t,i,o){var l,r,s=null,a="Unknown field";try{if(o)l=t;else if(l=e(t).children()[0],null===l||"NOBR"===l.nodeName)return null;a=e.trim(e(l).text()),r=a.lastIndexOf(" *")===a.length-2,!0===r&&(a=a.substring(0,a.length-2)),s={name:a,label:e(l),labelRow:e(t.parentNode),labelCell:t,isRequired:r,controlsRow:n(i)?null:e(i.parentNode),controlsCell:n(i)?null:i,type:null,spField:null}}catch(h){throw"getFieldParams error getting parameters for "+a+": "+(""+h)}return s}function y(){if(null===_){var t,n,i=e("table.ms-formtable td.ms-formlabel"),o=e("table.ms-formtable td.ms-formbodysurvey"),l=i.length;for($=o.length>0,_={},t=0;l>t;t+=1)n=f(i[t],o[t],$),null!==n&&(_[n.name]=n)}}function b(t,e,n){n?(t.show(),null!==e&&e.show()):(t.hide(),null!==e&&e.hide())}function v(t){t.ReadOnlyLabel&&t.ReadOnlyLabel.html(t.GetValue())}function x(t,n){try{e(t.Controls).hide(),null===t.ReadOnlyLabel&&(t.ReadOnlyLabel=e("<div/>").text(n).addClass("sputility-readonly"),e(t.Controls).after(t.ReadOnlyLabel)),t.ReadOnlyLabel.html(n),t.ReadOnlyLabel.show()}catch(i){throw"Error making "+t.Name+" read only. "+(""+i)}return t}function m(t){var n="";return t.each(function(){n+=e(this).text()+"; "}),n.length>2&&(n=n.substring(0,n.length-2)),n}function w(t){this.Label=t.label,this.LabelRow=t.labelRow,this.Name=t.name,this.IsRequired=t.isRequired,this.Type=t.type,this.Controls=e(t.controlsCell).children()[0],this.ControlsRow=t.controlsRow,this.ReadOnlyLabel=null}function F(t){w.call(this,t),this.Textbox=a(this)}function C(t){F.call(this,t)}function g(t){C.call(this,t),this.FormatOptions={eventHandler:null,autoCorrect:!1,decimalPlaces:2}}function T(t){if(w.call(this,t),null!==this.Controls){var n=e(this.Controls).find("input"),i=n.length;i>1&&"text"===n[i-1].type?(this.FillInTextbox=n[i-1],this.FillInElement=n[i-2],this.FillInAllowed=!0):(this.FillInAllowed=!1,this.FillInTextbox=null,this.FillInElement=null)}}function k(t,e){T.call(this,t),null!==this.Controls&&(this.Dropdown=e,this.Dropdown=1===this.Dropdown.length?this.Dropdown[0]:[])}function I(t){T.call(this,t),null!==this.Controls&&(this.RadioButtons=h(this,'input[type="radio"]'),this.FillInAllowed&&this.RadioButtons.pop())}function D(t){T.call(this,t),null!==this.Controls&&(this.Checkboxes=h(this,'input[type="checkbox"]'),this.FillInAllowed&&(this.FillInElement=this.Checkboxes.pop().value))}function V(t,e,l,r,s){if(this.Year=t,this.Month=e,this.Day=l,this.IsTimeIncluded=!n(r)&&!n(s),this.Hour="12 AM",this.HourInt=0,this.Minute="00",this.IsTimeIncluded){if(o(r)){if(0>r||r>23)throw"Hour number parameter must be between 0 and 23.";this.Hour=this.ConvertHourToString(r),this.HourInt=r}else if(i(r)){if(!this.IsValidHour(r))throw'Hour string parameter must be formatted like "1 PM" or "12 AM".';this.Hour=r,this.HourInt=this.ConvertHourToNumber(r)}if(!this.IsValidMinute(s))throw'Minute parameter is not in the correct format. Needs to be formatted like "00", "05" or "35".';this.Minute=s}}function S(t){if(w.call(this,t),this.DateTextbox=a(this),this.HourDropdown=null,this.MinuteDropdown=null,this.IsDateOnly=!0,this.HourValueFormat=null,null!==this.Controls){var n=e(this.Controls).find("select");null!==n&&2===n.length&&(this.HourDropdown=n[0],this.HourValueFormat=e(this.HourDropdown).val().indexOf(" ")>-1?"string":"number",this.MinuteDropdown=n[1],this.IsDateOnly=!1)}}function O(t){w.call(this,t),this.Checkbox=e(a(this))}function H(t){if(w.call(this,t),null!==this.Controls){this.TextboxURL=null,this.TextboxDescription=null;var n=e(this.Controls).find("input");null!==n&&2===n.length&&(this.TextboxURL=e(n[0]),this.TextboxDescription=e(n[1]))}}function R(t,e){if(w.call(this,t),null!==this.Controls){if(1!==e.length)throw"Unable to get dropdown element for "+this.Name;this.Dropdown=e[0]}}function P(t,n){if(w.call(this,t),null!==this.Controls){if(1!==n.length)throw"Unable to get input elements for "+this.Name;this.Textbox=e(n[0]),this.HiddenTextbox=e('input[id="'+this.Textbox.attr("optHid")+'"]')}}function L(t,e){w.call(this,t),this.Textbox=e,this.TextType="Plain"}function M(t,e){L.call(this,t,e),this.TextType="Rich"}function N(t,n){w.call(this,t),this.Textbox=n[0],this.ContentDiv=e(this.Controls).find('div[contenteditable="true"]')[0],this.TextType="Enhanced"}function G(t){F.call(this,t),this.FileExtension=e(this.Textbox).parent().text()}function E(t){if(w.call(this,t),null!==this.Controls){var n=e(this.Controls).find("select");if(2!==n.length)throw"Error initializing SPLookupMultiField named "+this.Name+", unable to get select controls.";this.ListChoices=n[0],this.ListSelections=n[1],n=e(this.Controls).find("button"),0===n.length&&(n=e(this.Controls).find('input[type="button"]')),this.ButtonAdd=n[0],this.ButtonRemove=n[1]}}function U(i){if(w.call(this,i),null!==this.Controls){this.spanUserField=null,this.upLevelDiv=null,this.textareaDownLevelTextBox=null,this.linkCheckNames=null,this.txtHiddenSpanData=null;var o=e(this.Controls).find("span.ms-usereditor");if(null!==o&&1===o.length)this.spanUserField=o[0],this.upLevelDiv=e(this.spanUserField.id+"_upLevelDiv"),this.textareaDownLevelTextBox=e(this.spanUserField.id+"_downlevelTextBox"),this.linkCheckNames=e(this.spanUserField.id+"_checkNames"),this.txtHiddenSpanData=e(this.spanUserField.id+"_hiddenSpanData"),this.GetValue=function(){return this.upLevelDiv.text()},this.SetValue=function(t){return e.browser.msie?(this.upLevelDiv.innerHTML=t,this.txtHiddenSpanData.val(t),this.linkCheckNames.click()):(this.textareaDownLevelTextBox.val(t),this.linkCheckNames.onclick()),v(this),this};else if(!n(t.SPClientPeoplePicker)){var l=e(this.Controls).children()[0];this.ClientPeoplePicker=t.SPClientPeoplePicker.SPClientPeoplePickerDict[e(l).attr("id")],this.EditorInput=e(this.Controls).find("[id$='_EditorInput']")[0],this.HiddenInput=e(this.Controls).find("[id$='_HiddenInput']")[0],this.AutoFillDiv=e(this.Controls).find("[id$='_AutoFillDiv']")[0],this.ResolvedList=e(this.Controls).find("[id$='_ResolvedList']")[0],this.GetValue=function(){var t=e(this.ResolvedList).find("span.ms-entity-resolved");return t.length>0?m(t):""},this.SetValue=function(t){return this.ClientPeoplePicker.AddUserKeys(t,!1),v(this),this}}}}function j(t){return"boolean"==typeof t&&(B=t),B}function A(t){y();var e=_[t];if(n(e))throw"Unable to get a SPField named "+t;return null===e.spField&&(e.spField=d(e)),e.spField}var _=null,B=!1,$=!1;w.prototype.Show=function(){return b(this.LabelRow,this.ControlsRow,!0),this},w.prototype.Hide=function(){return b(this.LabelRow,this.ControlsRow,!1),this},w.prototype.MakeReadOnly=function(){return x(this,""+this.GetValue())},w.prototype.MakeEditable=function(){try{e(this.Controls).show(),null!==this.ReadOnlyLabel&&e(this.ReadOnlyLabel).hide()}catch(t){alert("Error making "+this.Name+" editable. "+(""+t))}return this},w.prototype.toString=function(){return this.Name},w.prototype.GetValue=function(){throw"GetValue not yet implemented for "+this.Type+" in "+this.Name},w.prototype.SetValue=function(){throw"SetValue not yet implemented for "+this.Type+" in "+this.Name},F.prototype=Object.create(w.prototype),F.prototype.GetValue=function(){return e(this.Textbox).val()},F.prototype.SetValue=function(t){return e(this.Textbox).val(t),v(this),this},C.prototype=Object.create(F.prototype),C.prototype.GetValue=function(){return r(e(this.Textbox).val())},g.prototype=Object.create(C.prototype),g.prototype.Format=function(){this.FormatOptions.autoCorrect?(this.FormatOptions.eventHandler=e.proxy(function(){this.SetValue(this.GetFormattedValue())},this),e(this.Textbox).on("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler()):this.FormatOptions.eventHandler&&(e(this.Textbox).off("change",this.FormatOptions.eventHandler),this.FormatOptions.eventHandler=null)},g.prototype.GetFormattedValue=function(){var t=this.GetValue();return"number"==typeof t&&(t="$"+s(t,this.FormatOptions.decimalPlaces)),t},g.prototype.MakeReadOnly=function(){return x(this,this.GetFormattedValue())},T.prototype=Object.create(w.prototype),T.prototype._getFillInValue=function(){return e(this.FillInTextbox).val()},T.prototype._setFillInValue=function(t){this.FillInElement.checked=!0,e(this.FillInTextbox).val(t)},k.prototype=Object.create(T.prototype),k.prototype.GetValue=function(){return this.FillInAllowed&&this.FillInElement.checked===!0?this._getFillInValue():e(this.Dropdown).val()},k.prototype.SetValue=function(t){var n=e(this.Dropdown).find('option[value="'+t+'"]').length>0;if(!n&&this.FillInAllowed)n?(e(this.Dropdown).val(t),this.FillInElement.checked=!1):this._setFillInValue(t);else{if(!n)throw"Unable to set value for "+this.Name+' the value "'+t+'" was not found.';e(this.Dropdown).val(t)}return v(this),this},I.prototype=Object.create(T.prototype),I.prototype.GetValue=function(){var t=null;return e(this.RadioButtons).each(function(e,n){var i=n.value;return i.checked?(t=n.key,!1):void 0}),this.FillInAllowed&&null===t&&this.FillInElement.checked===!0&&(t=e(this.FillInTextbox).val()),t},I.prototype.SetValue=function(t){var e=u(this.RadioButtons,t);if(null===e){if(!this.FillInAllowed)throw"Unable to set value for "+this.Name+' the value "'+t+'" was not found.';this._setFillInValue(t)}else e.checked=!0;return v(this),this},D.prototype=Object.create(T.prototype),D.prototype.GetValue=function(){var t=[];return e(this.Checkboxes).each(function(e,n){var i=n.value;i.checked&&t.push(n.key)}),this.FillInAllowed&&this.FillInElement.checked===!0&&t.push(e(this.FillInTextbox).val()),t},D.prototype.SetValue=function(t,i){var o=u(this.Checkboxes,t);if(i=n(i)?!0:i,null===o){if(!this.FillInAllowed)throw"Unable to set value for "+this.Name+' the value "'+t+'" was not found.';o=this.FillInElement,e(this.FillInTextbox).val(t),o.checked=!0}else o.checked=!0;return v(this),this},V.prototype.IsValidDate=function(){return!n(this.Year)&&!n(this.Month)&&!n(this.Day)},V.prototype.IsValidHour=function(t){return!n(t)&&/^([1-9]|10|11|12) (AM|PM)$/.test(t)},V.prototype.IsValidMinute=function(t){return!n(t)&&/^([0-5](0|5))$/.test(t)},V.prototype.ConvertHourToString=function(t){var e;return e=0===t?"12 AM":t>12?""+(t-12)+" PM":""+t+" AM"},V.prototype.ConvertHourToNumber=function(t){var e;return t=t.split(" "),e=l(t[0]),"AM"===t[1]?12===e&&(e=0):"PM"===t[1]&&(e+=12),e},V.prototype.PadWithZero=function(t){return n(t)||null===t?"":i(t)&&(t=l(t),isNaN(t))?"":"number"==typeof t&&10>t?"0"+(""+t):""+t},V.prototype.GetShortDateString=function(){if(!this.IsValidDate())return"";var t=this.PadWithZero(this.Month)+"/"+this.PadWithZero(this.Day)+"/"+this.PadWithZero(this.Year);return t},V.prototype.toString=function(){var t,e=this.GetShortDateString();return this.IsTimeIncluded&&this.IsValidHour(this.Hour)&&this.IsValidMinute(this.Minute)&&(t=this.Hour.split(" "),e+=" "+t[0]+":"+this.Minute+t[1]),e},S.prototype=Object.create(w.prototype),S.prototype.GetValue=function(){var t,n,i=e(this.DateTextbox).val().split("/");return this.IsDateOnly||(t=e(this.HourDropdown).val(),"number"===this.HourValueFormat&&(t=l(t)),n=e(this.MinuteDropdown).val()),3===i.length?new V(i[2],i[0],i[1],t,n):""},S.prototype.SetValue=function(t,n,i,o,l){var r=new V(t,n,i,o,l);return e(this.DateTextbox).val(r.GetShortDateString()),null!==this.HourDropdown&&null!==this.MinuteDropdown&&("string"===this.HourValueFormat?e(this.HourDropdown).val(r.Hour):e(this.HourDropdown).val(r.HourInt),e(this.MinuteDropdown).val(r.Minute)),v(this),this},O.prototype=Object.create(w.prototype),O.prototype.GetValue=function(){return!!this.Checkbox.val()},O.prototype.SetValue=function(t){return this.Checkbox.val(t),v(this),this},H.prototype=Object.create(w.prototype),H.prototype.GetValue=function(){return[this.TextboxURL.val(),this.TextboxDescription.val()]},H.prototype.SetValue=function(t,e){return this.TextboxURL.val(t),this.TextboxDescription.val(e),v(this),this},H.prototype.MakeReadOnly=function(t){var e,n=this.GetValue();return e=t&&!0===t.TextOnly?n[0]+", "+n[1]:'<a href="'+n[0]+'">'+n[1]+"</a>",x(this,e)},R.prototype=Object.create(w.prototype),R.prototype.GetValue=function(){return this.Dropdown.options[this.Dropdown.selectedIndex].text},R.prototype.SetValue=function(t){if(o(t))e(this.Dropdown).val(t);else{var n,i,l;for(i=this.Dropdown.options,n=0;i.length>n;n+=1)if(l=i[n],l.text===t){this.Dropdown.selectedIndex=n;break}}return v(this),this},P.prototype=Object.create(w.prototype),P.prototype.GetValue=function(){return this.Textbox.val()},P.prototype.SetValue=function(t){var e,n,o,r,s,a=[];for(e=this.Textbox.attr("choices"),e=e.split(/\|(?=\d+)/),a.push(e[0]),r=1;e.length-1>r;r++)s=e[r].indexOf("|"),a.push(e[r].substring(0,s)),a.push(e[r].substring(s+1));for(a.push(e[e.length-1]),i(t)&&(t=t.replace("|","||")),r=0;a.length>r;r+=2)if(n=l(a[r+1]),o=a[r],t===n||t===o){this.Textbox.val(o.replace("||","|"));break}return null!==n&&this.HiddenTextbox.val(n),v(this),this},L.prototype=Object.create(w.prototype),L.prototype.GetValue=function(){return e(this.Textbox).val()},L.prototype.SetValue=function(t){return e(this.Textbox).val(t),v(this),this},M.prototype=Object.create(L.prototype),M.prototype.GetValue=function(){return t.RTE_GetIFrameContents(this.Textbox.id)},M.prototype.SetValue=function(n){return e(this.Textbox).val(n),t.RTE_TransferTextAreaContentsToIFrame(this.Textbox.id),v(this),this},N.prototype=Object.create(w.prototype),N.prototype.GetValue=function(){return e(this.ContentDiv).html()},N.prototype.SetValue=function(t){return e(this.ContentDiv).html(t),e(this.Textbox).val(t),v(this),this},G.prototype=Object.create(F.prototype),G.prototype.GetValue=function(){return e(this.Textbox).val()+this.FileExtension},E.prototype=Object.create(w.prototype),E.prototype.GetValue=function(){var t,e,n=[];for(e=this.ListSelections.options.length,t=0;e>t;t+=1)n.push(this.ListSelections.options[t].text);return n},E.prototype.MakeReadOnly=function(){return x(this,m(this.GetValue()))},E.prototype.SetValue=function(t,i){n(i)&&(i=!0);var l,r,s,a,h,u;for(i?(s=this.ListChoices.options,h=this.ButtonAdd):(s=this.ListSelections.options,h=this.ButtonRemove),a=s.length,o(t)?(t=""+t,u="value"):u="text",l=0;a>l;l+=1)r=s[l],r.selected=r[u]===t?!0:!1;return h.disabled="",e(h).click(),v(this),this},U.prototype=Object.create(w.prototype);var W=function(t){this._defaults={debug:!1},this.settings=e.extend({},t,this._defaults)};W.GetSPField=A,W.Debug=j,t.SPUtility=W}(window,jQuery);