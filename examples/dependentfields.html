<!DOCTYPE html>
<html>
<head>
   <!--

   WARNING: EXPERIMENTAL CODE as of 3/31/2016

   I haven't not used this in production anywhere!

   -->
  <meta charset="utf-8">
  <title>SPUtility.js: Dependent fields</title>
  <!-- Load local jQuery. This can be overridden with a ?jquery=___ param. -->
  <script src="../libs/jquery-loader.js"></script>
  <!-- Load local lib and tests. -->
  <script src="../src/sputility.js"></script>

<script>
function SPUtilityTreeNode(parent, name, value) {
   // parent node (SPUtilityTreeNode)
   this.parent = parent;
   // field's display name, used to get SPField
   this.name = name;
   // show this node when the value here matches the parent field's value
   this.value = value;
   // SPUtility.js SPField class
   this.field = SPUtility.GetSPField(name);
   // array of dependent nodes (SPUtilityTreeNode)
   this.childNodes = [];
   // callback function which shows or hides dependent fields
   this.callback = this._showOrHideFieldsCallback.bind(this);
   // schedule callback for when they change the field
   // TODO: only works for dropdown fields right now
   $(this.field.Dropdown).change(this.callback);
}
SPUtilityTreeNode.prototype._hideNodeAndChildren = function (node) {
   // when field is hidden, hide all dependent children as well
   node.field.Hide();
   for (var i = 0; i < node.childNodes.length; i++) {
      // recurse down the tree to hide all children
      this._hideNodeAndChildren(node.childNodes[i]);
   }
};
SPUtilityTreeNode.prototype._showNodeAndChildren = function (node) {
   // when field is visible, re-evaluate all the children
   // to determine whether to Show or Hide them
   node.field.Show();
   node.callback();
};
SPUtilityTreeNode.prototype._getOrCreateChild = function (name, value) {
   for (var i = 0; i < this.childNodes.length; i++) {
      if (this.childNodes[i].name === name && this.childNodes[i].value === value) {
         // found matching child node
         return this.childNodes[i];
      }
   }
   var newNode = new SPUtilityTreeNode(this, name, value);
   this.childNodes.push(newNode);
   return newNode;
};
SPUtilityTreeNode.prototype._showOrHideFieldsCallback = function () {
   var value = this.field.GetValue();
   // go through each dependent child node
   // and show/hide it based on the field's value
   for (var i = 0; i < this.childNodes.length; i++) {
      if (this.childNodes[i].value === value) {
         this._showNodeAndChildren(this.childNodes[i]);
      } else {
         this._hideNodeAndChildren(this.childNodes[i]);
      }
   }
};
SPUtilityTreeNode.prototype.addChildNode = function (name, value) {
   var childNode = this._getOrCreateChild(name, value);
};
function SPUtilityTree(name) {
   this.root = new SPUtilityTreeNode(null, name);
   this.currentNode = null;
   this.currentValue = null;
}
SPUtilityTree.prototype._findNode = function (node, searchName) {
   if (node.name === searchName) {
      return node;
   }
   // search the children
   for (var i = 0; i < node.childNodes.length; i++) {
      var foundNode = this._findNode(node.childNodes[i], searchName);
      if (foundNode !== null) {
         return foundNode;
      }
   }
   return null;
};
// select a node in the tree
SPUtilityTree.prototype.whenField = function (fieldName) {
   // reset currentNode before searching
   this.currentNode = this._findNode(this.root, fieldName);
   if (this.currentNode === null) {
      console.log('ERROR: Field ' + fieldName + ' was not found in the tree!');
   }
   return this;
};

SPUtilityTree.prototype.hasValue = function (fieldValue) {
   this.currentValue = null;
   if (this.currentNode === null) {
      console.log('ERROR: Current node is not set, call whenField first.');
      return this;
   }
   this.currentValue = fieldValue;
   return this;
};

SPUtilityTree.prototype.showFields = function (fieldNames, fieldValue) {
   // add a dependent child node
   for (var i = 0; i < fieldNames.length; i++) {
      this.currentNode.addChildNode(fieldNames[i], this.currentValue);
   }
};
SPUtilityTree.prototype.print = function (str, node, level) {
   var spacing = '';
   for (var i = 0; i < level; i++) {
      spacing += "  "
   }
   str += spacing + level + ') ' + node.name + '\n';
   for (var i = 0; i < node.childNodes.length; i++) {
      str = this.print(str, node.childNodes[i], level+1);
   }
   return str;
};
SPUtilityTree.prototype._executeCallbacks = function (node) {
   if (node.callback !== null) {
      node.callback();
   }
   for (var i = 0; i < node.childNodes.length; i++) {
      this._executeCallbacks(node.childNodes[i]);
   }
};
SPUtilityTree.prototype.build = function () {
   console.log("Building tree...");
   console.log(this.print('', this.root, 0));
   console.log("Executing callbacks...")
   this._executeCallbacks(this.root);
};

// wait for the window to load
$(document).ready(function () {
   var cakeTree = new SPUtilityTree('Do you want cake?');
   // add two dependencies on 'Do you want cake?' with different values
   cakeTree.whenField('Do you want cake?').hasValue('Yes')
   .showFields(['Do you want ice cream with your cake?']);
   cakeTree.whenField('Do you want cake?').hasValue('No')
   .showFields(['Do you want a donut?']);
   // add two dependencies on 'Do you want ice cream with your cake?' with same value
   cakeTree.whenField('Do you want ice cream with your cake?').hasValue('Yes').showFields([
      'Do you want chocolate ice cream?',
      'Do you want vanilla ice cream?'
   ]);
   // done adding additional field dependencies
   // build the tree which prints it out and initializes the form
   cakeTree.build();
   // dropdown fields are now hidden automatically based on the selection!
});
</script>
</head>
<body>

<div id="qunit"></div>

<!-- start of sharepoint markup -->
<table class="ms-formtable" style="margin-top: 8px;" border="0" cellpadding="0" cellspacing="0" width="100%">



		<tbody><tr>
		<td class="ms-formlabel" nowrap="true" valign="top" width="113px"><span class="ms-h3 ms-standardheader">
		<nobr>Title<span class="ms-accentText" title="This is a required field."> *</span></nobr>
	</span></td>
		<td class="ms-formbody" valign="top" width="350px">
		<!-- FieldName="Title"
			 FieldInternalName="Title"
			 FieldType="SPFieldText"
		  -->
			<span dir="none"><input value="" maxlength="255" id="Title_fa564e0f-0c70-4ab9-b863-0177e6ddd247_$TextField" title="Title Required Field" style="ime-mode : " class="ms-long ms-spellcheck-true" type="text"><br></span>



		</td>
	</tr>

		<tr>
		<td class="ms-formlabel" nowrap="true" valign="top" width="113px"><span class="ms-h3 ms-standardheader">
		<nobr>Do you want cake?</nobr>
	</span></td>
		<td class="ms-formbody" valign="top" width="350px">
		<!-- FieldName="Do you want cake?"
			 FieldInternalName="Field_x0020_A"
			 FieldType="SPFieldChoice"
		  -->
			<span dir="none">
         <select id="Field_x0020_A_ed507737-3779-4a7a-a366-cdc3152def92_$DropDownChoice" title="Do you want cake?" class="ms-RadioText">
            <option value="Yes">Yes</option>
            <option value="No" selected="selected">No</option>
         </select><br></span>



		</td>
	</tr>

		<tr>
		<td class="ms-formlabel" nowrap="true" valign="top" width="113px"><span class="ms-h3 ms-standardheader">
		<nobr>Do you want ice cream with your cake?</nobr>
	</span></td>
		<td class="ms-formbody" valign="top" width="350px">
		<!-- FieldName="Do you want ice cream with your cake?"
			 FieldInternalName="Field_x0020_B"
			 FieldType="SPFieldChoice"
		  -->
			<span dir="none"><select id="Field_x0020_B_fb1ad62d-13be-421e-97ef-a92d50da669b_$DropDownChoice" title="Do you want ice cream with your cake?" class="ms-RadioText"><option value="Yes">Yes</option><option value="No" selected="selected">No</option></select><br></span>



		</td>
	</tr>

		<tr>
		<td class="ms-formlabel" nowrap="true" valign="top" width="113px"><span class="ms-h3 ms-standardheader">
		<nobr>Do you want a donut?</nobr>
	</span></td>
		<td class="ms-formbody" valign="top" width="350px">
		<!-- FieldName="Do you want a donut?"
			 FieldInternalName="Field_x0020_C"
			 FieldType="SPFieldChoice"
		  -->
			<span dir="none"><select id="Field_x0020_C_0a258681-88e8-4819-966f-bc2e14e7d2d3_$DropDownChoice" title="Do you want a donut?" class="ms-RadioText"><option value="Yes">Yes</option><option value="No" selected="selected">No</option></select><br></span>



		</td>
	</tr>

		<tr>
		<td class="ms-formlabel" nowrap="true" valign="top" width="113px"><span class="ms-h3 ms-standardheader">
		<nobr>Do you want chocolate ice cream?</nobr>
	</span></td>
		<td class="ms-formbody" valign="top" width="350px">
		<!-- FieldName="Do you want chocolate ice cream?"
			 FieldInternalName="Field_x0020_D"
			 FieldType="SPFieldChoice"
		  -->
			<span dir="none"><select id="Field_x0020_D_8c420c10-877c-4519-b4e0-970a7c3391b1_$DropDownChoice" title="Do you want chocolate ice cream?" class="ms-RadioText"><option value="Yes">Yes</option><option value="No" selected="selected">No</option></select><br></span>



		</td>
	</tr>

		<tr>
		<td class="ms-formlabel" nowrap="true" valign="top" width="113px"><span class="ms-h3 ms-standardheader">
		<nobr>Do you want vanilla ice cream?</nobr>
	</span></td>
		<td class="ms-formbody" valign="top" width="350px">
		<!-- FieldName="Do you want vanilla ice cream?"
			 FieldInternalName="Field_x0020_E"
			 FieldType="SPFieldChoice"
		  -->
			<span dir="none"><select id="Field_x0020_E_842def70-b63c-4da9-8793-008054221934_$DropDownChoice" title="Do you want vanilla ice cream?" class="ms-RadioText"><option value="Yes">Yes</option><option value="No" selected="selected">No</option></select><br></span>



		</td>
	</tr>

</tbody></table>
<!-- end of sharepoint markup -->
</body>
</html>
